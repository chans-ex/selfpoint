
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í¬ì¸íŠ¸ ê´€ë¦¬</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body style="margin:0; background:#e5e7eb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, Fragment } = React;

    const TEST_IDS = [
      'TMPDScb32d04b64d94a9', 'TMPDS4abdb524d673492', 'TMPDS5254acb93dbe46c',
      'TMPDSa2686c826a28485', 'TMPDS6a4757e6a3c34cc', 'TMPDSc53c81cb026f488',
      'TMPDS067d9b743d17463', 'TMPDS43098c59653c486', 'TMPDS21c02640426e436',
      'TMPDS8b09cd30f54e476', 'TMPDSd27bf78fb8e546a', 'TMPDSd5034a6fbad64be',
      'TMPDS77970861beae492', 'TMPDS28c045ff094843a', 'TMPDS4ccba6a2a15040e',
      'TMPDS731a0fb561354e0', 'TMPDS9fb6acec8fe14b8', 'TMPDSa9f21742c6e1b84',
      'TMPDSe5a4afa77d6346f', 'TMPDS1e7083124613423', 'TMPDSabb9d72cecd244d',
      'TMPDS4ecbd717abc5486', 'TMPDS87a0f273848f4d2', 'TMPDSc788cf5178fa428', 'dongatest',
    ];

    // Google Sheets API ì„¤ì •
    const GOOGLE_CLIENT_ID = '1017191070280-5ntddd47p1sh9q2fj8k7j3na9lcjpjoq.apps.googleusercontent.com';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1CR26WesDpfOUjekd2_2_0shJuwhSjVNkEMq74BujL1k/edit?usp=sharing';
    
    const maskName = (name) => {
      if (!name) return '-';
      if (name.length === 2) return name[0] + '*';
      if (name.length === 3) return name[0] + '*' + name[2];
      if (name.length > 3) return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1];
      return name;
    };

    // Google Sheets ê´€ë ¨ í•¨ìˆ˜
    const loadGoogleSheetsData = async (accessToken, sheetUrl) => {
      try {
        // ì‹œíŠ¸ ID ì¶”ì¶œ
        const match = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        if (!match) throw new Error('ì˜¬ë°”ë¥¸ êµ¬ê¸€ ì‹œíŠ¸ URLì´ ì•„ë‹™ë‹ˆë‹¤');
        const spreadsheetId = match[1];

        // ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1!A:Z`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );

        if (!response.ok) throw new Error('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        
        const data = await response.json();
        const rows = data.values;
        
        if (!rows || rows.length === 0) throw new Error('ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');

        // ì²« í–‰ì„ í—¤ë”ë¡œ, ë‚˜ë¨¸ì§€ë¥¼ ë°ì´í„°ë¡œ ë³€í™˜
        const headers = rows[0];
        const jsonData = rows.slice(1).map(row => {
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = row[index] || '';
          });
          return obj;
        });

        return jsonData;
      } catch (error) {
        console.error('Google Sheets ë¡œë“œ ì—ëŸ¬:', error);
        throw error;
      }
    };
   
    // ì—…ì²´ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
    const getCompanyCategory = (company) => {
      if (!company || company === 'CS ìˆ˜ë™ì°¨ê°') return 'etc';
      if (company === 'ë™ì•„ì‚¬ì´ì–¸ìŠ¤ë§¤ê±°ì§„' || company.startsWith('ì…€ëŸ½_')) return 'subscription';
      if (company === 'dë¼ì´ë¸ŒëŸ¬ë¦¬' || company === 'ë””ë¼ì´ë¸ŒëŸ¬ë¦¬') return 'digital';
      return 'store';
    };

    const getCategoryLabel = (category) => {
      if (category === 'subscription') return 'ì •ê¸°êµ¬ë…';
      if (category === 'digital') return 'ë””ì§€í„¸ì½˜í…ì¸ ';
      if (category === 'store') return 'ì…ì ì‚¬';
      return '';
    };

    // ì·¨ì†Œ ì—¬ë¶€ íŒë‹¨
    const isCancelTransaction = (row) => {
      if (row['íƒ€ì…'] !== 'ì‚¬ìš©') return false;
      const company = row['ì—…ì²´ëª…'] || '';
      const adminMemo = row['ê´€ë¦¬ìë©”ëª¨'] || '';
      const userMemo = row['ì‚¬ìš©ìë©”ëª¨'] || '';
      
      // ì—…ì²´ëª… ì—†ìŒ OR ë©”ëª¨ì— "ì·¨ì†Œ" í¬í•¨
      return !company || adminMemo.includes('ì·¨ì†Œ') || userMemo.includes('ì·¨ì†Œ');
    };

    function App() {
      const [data, setData] = useState([]);
      const [fileName, setFileName] = useState('');
      const [mainTab, setMainTab] = useState('earn');
      const [useSubTab, setUseSubTab] = useState('company');
      const [cancelSubTab, setCancelSubTab] = useState('type');
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedMonth, setSelectedMonth] = useState('');
      const [showCanceled, setShowCanceled] = useState(false);
      const [expandedUser, setExpandedUser] = useState(null);
      const [expandedEarn, setExpandedEarn] = useState(null);
      const [expandedCancel, setExpandedCancel] = useState(null);
      const [showMismatchOnly, setShowMismatchOnly] = useState(false);
         const [googleAccessToken, setGoogleAccessToken] = useState(() => {
        return localStorage.getItem('googleAccessToken') || '';
      });
      const [isGoogleSignedIn, setIsGoogleSignedIn] = useState(() => {
        return !!localStorage.getItem('googleAccessToken');
      });
      const [sheetUrl, setSheetUrl] = useState(DEFAULT_SHEET_URL);

      
      // í˜ì´ì§€ ë¡œë“œì‹œ ì €ì¥ëœ URL ë¶ˆëŸ¬ì˜¤ê¸°
      React.useEffect(() => {
        const savedUrl = localStorage.getItem('savedSheetUrl');
        if (savedUrl) {
          setSheetUrl(savedUrl);
        }
      }, []);

      // ë¡œê·¸ì¸ ë©´ ìë™ ë¡œë“œ
      React.useEffect(() => {
        if (isGoogleSignedIn && googleAccessToken && data.length === 0) {
          handleLoadSheet();
        }
      }, [isGoogleSignedIn, googleAccessToken]);

      
       // Google Sign In í•¸ë“¤ëŸ¬
      const handleGoogleSignIn = () => {
        const client = google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: SCOPES,
          callback: (response) => {
            setGoogleAccessToken(response.access_token);
            setIsGoogleSignedIn(true);
            localStorage.setItem('googleAccessToken', response.access_token);
          },
        });
        client.requestAccessToken();
      };

    // Google ì‹œíŠ¸ ë¡œë“œ
      const handleLoadSheet = async () => {
        if (!sheetUrl) {
          alert('êµ¬ê¸€ ì‹œíŠ¸ URLì„ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }
        try {
          const jsonData = await loadGoogleSheetsData(googleAccessToken, sheetUrl);
          setData(jsonData);
          setFileName('Google Sheets');
          localStorage.setItem('savedSheetUrl', sheetUrl); // â† ì´ ì¤„ ì¶”ê°€
          if (jsonData.length > 0) {
            const firstDate = jsonData[0]['ì²˜ë¦¬ì¼'] || '';
            const match = firstDate.match(/(\d{4})\/(\d{2})/);
            if (match) setSelectedMonth(match[1] + '-' + match[2]);
          }
        } catch (error) {
          alert('ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        }
      };

         const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setFileName(file.name);
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const workbook = XLSX.read(event.target.result, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            setData(jsonData);
            if (jsonData.length > 0) {
              const firstDate = jsonData[0]['ì²˜ë¦¬ì¼'] || '';
              const match = firstDate.match(/(\d{4})\/(\d{2})/);
              if (match) setSelectedMonth(match[1] + '-' + match[2]);
            }
          } catch (err) { console.error(err); }
        };
        reader.readAsArrayBuffer(file);
      };

      const realData = useMemo(() => data.filter(item => !TEST_IDS.includes(item['ê³ ê°ID'])), [data]);
      
      const canceledOrderNos = useMemo(() => {
        const nos = new Set();
        realData.forEach(r => {
          if (r['ì£¼ë¬¸ìƒíƒœ'] === 'ì·¨ì†Œì™„ë£Œ' && r['ì£¼ë¬¸ë²ˆí˜¸']) {
            nos.add(String(r['ì£¼ë¬¸ë²ˆí˜¸']));
          }
        });
        return nos;
      }, [realData]);
      
      const validData = useMemo(() => {
        if (showCanceled) return realData;
        return realData.filter(item => {
          const memo = item['ê´€ë¦¬ìë©”ëª¨'] || '';
          if (item['ì£¼ë¬¸ìƒíƒœ'] === 'ì·¨ì†Œì™„ë£Œ') return false;
          if (item['íƒ€ì…'] !== 'ì‚¬ìš©') {
            if (memo.includes('ì·¨ì†Œ í¬ì¸íŠ¸') || memo.includes('ì·¨ì†Œí¬ì¸íŠ¸')) {
              const match = memo.match(/(\d{10})/);
              if (match && canceledOrderNos.has(match[1])) return false;
            }
          }
          return true;
        });
      }, [realData, showCanceled, canceledOrderNos]);
      
      const canceledCount = useMemo(() => realData.filter(item => item['ì£¼ë¬¸ìƒíƒœ'] === 'ì·¨ì†Œì™„ë£Œ').length, [realData]);
      const monthlyData = useMemo(() => !selectedMonth ? validData : validData.filter(row => (row['ì²˜ë¦¬ì¼'] || '').startsWith(selectedMonth.replace('-', '/'))), [validData, selectedMonth]);
      const monthlyAllData = useMemo(() => !selectedMonth ? realData : realData.filter(row => (row['ì²˜ë¦¬ì¼'] || '').startsWith(selectedMonth.replace('-', '/'))), [realData, selectedMonth]);
      
      const availableMonths = useMemo(() => { const m = new Set(); realData.forEach(r => { const d = r['ì²˜ë¦¬ì¼'] || ''; const match = d.match(/(\d{4})\/(\d{2})/); if(match) m.add(match[1]+'-'+match[2]); }); return Array.from(m).sort().reverse(); }, [realData]);
      
      // ì ë¦½/ì‚¬ìš©/ì·¨ì†Œ ë°ì´í„° ë¶„ë¦¬
      const earnData = useMemo(() => monthlyData.filter(r => r['íƒ€ì…'] !== 'ì‚¬ìš©'), [monthlyData]);
      const useData = useMemo(() => monthlyData.filter(r => r['íƒ€ì…'] === 'ì‚¬ìš©' && !isCancelTransaction(r)), [monthlyData]);
      const cancelData = useMemo(() => monthlyData.filter(r => isCancelTransaction(r)), [monthlyData]);

      const carryoverPoint = useMemo(() => {
        if (!selectedMonth) return 0;
        const prevData = validData.filter(row => { const d = row['ì²˜ë¦¬ì¼'] || ''; return d.substring(0,7).replace('/','-') < selectedMonth; });
        if (prevData.length === 0) return 0;

        // ì‚¬ìš©ìë³„ë¡œ ë™ì¼í•œ ë¡œì§ ì ìš©
        const userMap = new Map();
        prevData.sort((a,b) => (a['ì²˜ë¦¬ì¼']||'').localeCompare(b['ì²˜ë¦¬ì¼']||'')).forEach(r => {
          const id = r['ê³ ê°ID'];
          const date = r['ì²˜ë¦¬ì¼'] || '';
          const total = Number(r['í† íƒˆí¬ì¸íŠ¸']) || 0;
          const point = Number(r['í¬ì¸íŠ¸']) || 0;
          const orderNo = r['ì£¼ë¬¸ë²ˆí˜¸'] || '';
          
          if (!userMap.has(id)) userMap.set(id, { transactions: [] });
          userMap.get(id).transactions.push({ date, total, point, orderNo });
        });
        
        // ê° ì‚¬ìš©ìì˜ ë§ˆì§€ë§‰ currentPoint ê³„ì‚°
        let totalCarryover = 0;
        userMap.forEach((user, id) => {
          const sortedTx = [...user.transactions].sort((a,b) => a.date.localeCompare(b.date));
          const lastDate = sortedTx[sortedTx.length - 1].date;
          const lastDateTxs = sortedTx.filter(tx => tx.date === lastDate);
          
          const lastOrderNos = [...new Set(lastDateTxs.filter(tx => tx.orderNo && tx.orderNo !== '-').map(tx => tx.orderNo))];
          
          let currentPoint = 0;
          if (lastOrderNos.length > 0) {
            const orderTxs = sortedTx.filter(tx => lastOrderNos.includes(tx.orderNo));
            const hasEarn = lastDateTxs.some(tx => tx.point > 0);
            currentPoint = hasEarn ? Math.max(...orderTxs.map(tx => tx.total)) : Math.min(...orderTxs.map(tx => tx.total));
          } else {
            currentPoint = Math.min(...lastDateTxs.map(tx => tx.total));
          }
          
          totalCarryover += currentPoint;
        });
        
        return totalCarryover;
      }, [validData, selectedMonth]);

      const monthlyTotals = useMemo(() => {
        let used=0, earned=0, canceled=0;
        useData.forEach(r => { used += Number(r['í¬ì¸íŠ¸'])||0; });
        earnData.forEach(r => { earned += Number(r['í¬ì¸íŠ¸'])||0; });
        cancelData.forEach(r => { canceled += Number(r['í¬ì¸íŠ¸'])||0; });
        return { used, earned, canceled, carryover: carryoverPoint, balance: carryoverPoint + earned + used + canceled };
      }, [useData, earnData, cancelData, carryoverPoint]);


      const earnByType = useMemo(() => {
        const map = new Map();
        earnData.forEach(row => {
          let memo = (row['ê´€ë¦¬ìë©”ëª¨'] || '(ë©”ëª¨ì—†ìŒ)').trim().replace(/\n/g, '');
          const point = Number(row['í¬ì¸íŠ¸']) || 0;
          const userId = row['ê³ ê°ID'];
          const date = (row['ì²˜ë¦¬ì¼'] || '').substring(0, 10);
          const isCancelRefund = memo.includes('ì·¨ì†Œ í¬ì¸íŠ¸') || memo.includes('ì·¨ì†Œí¬ì¸íŠ¸');
          if (!map.has(memo)) map.set(memo, { memo, totalPoint: 0, users: new Set(), dates: new Map(), isCancelRefund });
          const item = map.get(memo);
          item.totalPoint += point;
          item.users.add(userId);
          if (!item.dates.has(date)) item.dates.set(date, { point: 0, count: 0 });
          item.dates.get(date).point += point;
          item.dates.get(date).count += 1;
        });
        return Array.from(map.values()).map(item => ({
          memo: item.memo, totalPoint: item.totalPoint, userCount: item.users.size, isCancelRefund: item.isCancelRefund,
          dateList: Array.from(item.dates.entries()).map(([d, v]) => ({ date: d, point: v.point, count: v.count })).sort((a,b) => a.date.localeCompare(b.date))
        })).sort((a,b) => {
          if (a.isCancelRefund && !b.isCancelRefund) return 1;
          if (!a.isCancelRefund && b.isCancelRefund) return -1;
          return b.totalPoint - a.totalPoint;
        });
      }, [earnData]);

      // ì·¨ì†Œë‚´ì—­: ìœ í˜•ë³„
      const cancelByType = useMemo(() => {
        const map = new Map();
        cancelData.forEach(row => {
          let memo = (row['ê´€ë¦¬ìë©”ëª¨'] || row['ì‚¬ìš©ìë©”ëª¨'] || '(ë©”ëª¨ì—†ìŒ)').trim().replace(/\n/g, '');
          const point = Math.abs(Number(row['í¬ì¸íŠ¸']) || 0);
          const userId = row['ê³ ê°ID'];
          const date = (row['ì²˜ë¦¬ì¼'] || '').substring(0, 10);
          if (!map.has(memo)) map.set(memo, { memo, totalPoint: 0, users: new Set(), dates: new Map() });
          const item = map.get(memo);
          item.totalPoint += point;
          item.users.add(userId);
          if (!item.dates.has(date)) item.dates.set(date, { point: 0, count: 0 });
          item.dates.get(date).point += point;
          item.dates.get(date).count += 1;
        });
        return Array.from(map.values()).map(item => ({
          memo: item.memo, totalPoint: item.totalPoint, userCount: item.users.size,
          dateList: Array.from(item.dates.entries()).map(([d, v]) => ({ date: d, point: v.point, count: v.count })).sort((a,b) => a.date.localeCompare(b.date))
        })).sort((a,b) => b.totalPoint - a.totalPoint);
      }, [cancelData]);

      // ì·¨ì†Œë‚´ì—­: ì‚¬ìš©ìë³„
      const cancelUserStats = useMemo(() => {
        const map = new Map();
        cancelData.forEach(row => {
          const id = row['ê³ ê°ID'];
          const name = row['ê³ ê°ëª…'];
          const point = Math.abs(Number(row['í¬ì¸íŠ¸']) || 0);
          const date = row['ì²˜ë¦¬ì¼'] || '';
          const memo = row['ê´€ë¦¬ìë©”ëª¨'] || row['ì‚¬ìš©ìë©”ëª¨'] || '';
          
          if (!map.has(id)) map.set(id, { id, name, totalPoint: 0, transactions: [] });
          const user = map.get(id);
          user.totalPoint += point;
          user.transactions.push({ date, point, memo });
        });
        return Array.from(map.values()).sort((a,b) => b.totalPoint - a.totalPoint);
      }, [cancelData]);

      const companyStats = useMemo(() => {
        const map = new Map();
        useData.forEach(row => {
          const company = row['ì—…ì²´ëª…'] || 'CS ìˆ˜ë™ì°¨ê°';
          const point = Number(row['í¬ì¸íŠ¸']) || 0;
          const userId = row['ê³ ê°ID'];
          const category = getCompanyCategory(company);
          if (!map.has(company)) map.set(company, { company, usedPoint: 0, users: new Set(), category });
          map.get(company).usedPoint += point;
          map.get(company).users.add(userId);
        });
        return Array.from(map.values()).map(c => ({ company: c.company, usedPoint: c.usedPoint, userCount: c.users.size, category: c.category })).sort((a,b) => {
          const order = { subscription: 0, digital: 1, store: 2, etc: 3 };
          if (order[a.category] !== order[b.category]) return order[a.category] - order[b.category];
          if (a.company === 'CS ìˆ˜ë™ì°¨ê°') return 1;
          if (b.company === 'CS ìˆ˜ë™ì°¨ê°') return -1;
          return a.usedPoint - b.usedPoint;
        });
      }, [useData]);

      const categoryTotals = useMemo(() => {
        const totals = { subscription: 0, digital: 0, store: 0, etc: 0 };
        companyStats.forEach(c => {
          totals[c.category] += c.usedPoint;
        });
        return totals;
      }, [companyStats]);

      const productStats = useMemo(() => {
        const map = new Map();
        useData.forEach(row => {
          const productCode = row['ìƒí’ˆì½”ë“œ'] || '';
          const company = row['ì—…ì²´ëª…'] || '';
          const point = Number(row['í¬ì¸íŠ¸']) || 0;
          const userId = row['ê³ ê°ID'];
          
          if (!productCode) {
            const key = '__CS_MANUAL__';
            if (!map.has(key)) map.set(key, { productCode: '-', company: 'CS ìˆ˜ë™ì°¨ê°', productName: '(ìˆ˜ë™ ì°¨ê° í•©ê³„)', usedPoint: 0, users: new Set() });
            map.get(key).usedPoint += point;
            map.get(key).users.add(userId);
            return;
          }
          
          const memo = row['ì‚¬ìš©ìë©”ëª¨'] || row['ê´€ë¦¬ìë©”ëª¨'] || '';
          const match = memo.match(/ìƒí’ˆëª…\(([^)]+)\)/);
          const productName = match ? match[1] : (memo || '-');
          const key = productCode;
          if (!map.has(key)) map.set(key, { productCode, company: company || '-', productName, usedPoint: 0, users: new Set() });
          map.get(key).usedPoint += point;
          map.get(key).users.add(userId);
        });
        return Array.from(map.values()).map(p => ({ productCode: p.productCode, company: p.company, productName: p.productName, usedPoint: p.usedPoint, userCount: p.users.size })).sort((a,b) => {
          if (a.productCode === '-') return 1;
          if (b.productCode === '-') return -1;
          return a.usedPoint - b.usedPoint;
        });
      }, [useData]);

      const userStats = useMemo(() => {
        const map = new Map();
        const sorted = [...monthlyAllData].sort((a,b) => (a['ì²˜ë¦¬ì¼']||'').localeCompare(b['ì²˜ë¦¬ì¼']||''));
        
        sorted.forEach(row => {
          const id = row['ê³ ê°ID'], name = row['ê³ ê°ëª…'], point = Number(row['í¬ì¸íŠ¸'])||0, total = Number(row['í† íƒˆí¬ì¸íŠ¸'])||0, type = row['íƒ€ì…'], date = row['ì²˜ë¦¬ì¼']||'';
          const orderNo = row['ì£¼ë¬¸ë²ˆí˜¸'] || '';
          const isCancel = isCancelTransaction(row);
          
          if (!map.has(id)) map.set(id, { id, name, startPoint:0, earnedPoint:0, usedPoint:0, canceledPoint:0, currentPoint:0, calculatedPoint:0, mismatch:false, transactions:[], orderGroups: new Map() });
          const u = map.get(id);
          u.name = name;
          
          if (isCancel) u.canceledPoint += point;
          else if (type === 'ì‚¬ìš©') u.usedPoint += point;
          else u.earnedPoint += point;
          
          u.transactions.push({ date, type: isCancel ? 'ì ë¦½ì·¨ì†Œ' : type, point, total, orderNo: String(orderNo), memo: row['ì‚¬ìš©ìë©”ëª¨'] || row['ê´€ë¦¬ìë©”ëª¨'] || '', status: row['ì£¼ë¬¸ìƒíƒœ'] || '' });
          
          // ì£¼ë¬¸ë²ˆí˜¸ë³„ ê·¸ë£¹í•‘
          if (orderNo && orderNo !== '-') {
            if (!u.orderGroups.has(orderNo)) {
              u.orderGroups.set(orderNo, { points: [], totals: [], startTotal: total });
            }
            const group = u.orderGroups.get(orderNo);
            group.points.push(point);
            group.totals.push(total);
            // ê·¸ë£¹ì˜ ì²« í† íƒˆì„ ì‹œì‘ì ìœ¼ë¡œ (í¬ì¸íŠ¸ ë³€í™” ì „)
            if (total - point < group.startTotal) {
              group.startTotal = total - point;
            }
          }
        });
        
       // ìµœì¢… í† íƒˆí¬ì¸íŠ¸ ê³„ì‚°: ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œì˜ ê±°ë˜ë“¤ì„ ë¶„ì„
        map.forEach((u, id) => {
          if (u.transactions.length === 0) {
            u.currentPoint = 0;
            return;
          }
          
          // ì‹œê°„ìˆœ ì •ë ¬
          const sortedTx = [...u.transactions].sort((a,b) => a.date.localeCompare(b.date));
          const lastDate = sortedTx[sortedTx.length - 1].date;
          const lastDateTxs = sortedTx.filter(tx => tx.date === lastDate);
          
          // ë§ˆì§€ë§‰ ë‚ ì§œì— ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆëŠ” ê±°ë˜ê°€ ìˆëŠ”ì§€ í™•ì¸
          const lastOrderNos = [...new Set(lastDateTxs.filter(tx => tx.orderNo && tx.orderNo !== '-').map(tx => tx.orderNo))];
          
          if (lastOrderNos.length > 0) {
            // ë§ˆì§€ë§‰ ë‚ ì§œì— ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆìœ¼ë©´, ê·¸ ì£¼ë¬¸ë²ˆí˜¸ë“¤ì˜ ëª¨ë“  ê±°ë˜ ì°¾ê¸°
            const orderTxs = sortedTx.filter(tx => lastOrderNos.includes(tx.orderNo));
           // ë§ˆì§€ë§‰ ë‚ ì§œì— ì ë¦½ì´ ìˆìœ¼ë©´ ìµœëŒ“ê°’, ì‚¬ìš©ë§Œ ìˆìœ¼ë©´ ìµœì†Ÿê°’
            const hasEarn = lastDateTxs.some(tx => tx.point > 0);
            u.currentPoint = hasEarn ? Math.max(...orderTxs.map(tx => tx.total)) : Math.min(...orderTxs.map(tx => tx.total));
         
          } else {
            // ì£¼ë¬¸ë²ˆí˜¸ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë‚ ì§œ ê±°ë˜ë“¤ ì¤‘ ìµœì†Ÿê°’ (ìµœì¢… ìƒíƒœ)
            u.currentPoint = Math.min(...lastDateTxs.map(tx => tx.total));
          }
        });
        
        if (selectedMonth) {
           const prevData = realData.filter(r => (r['ì²˜ë¦¬ì¼']||'').substring(0,7).replace('/','-') < selectedMonth).sort((a,b) => (a['ì²˜ë¦¬ì¼']||'').localeCompare(b['ì²˜ë¦¬ì¼']||''));
          const prevUser = new Map();
          
          // ì‚¬ìš©ìë³„ë¡œ ê·¸ë£¹í™”í•´ì„œ ë§ˆì§€ë§‰ í† íƒˆí¬ì¸íŠ¸ ê³„ì‚°
          const prevUserMap = new Map();
          prevData.forEach(r => {
            const id = r['ê³ ê°ID'];
            if (!prevUserMap.has(id)) prevUserMap.set(id, []);
            prevUserMap.get(id).push({ date: r['ì²˜ë¦¬ì¼'], total: Number(r['í† íƒˆí¬ì¸íŠ¸'])||0, orderNo: r['ì£¼ë¬¸ë²ˆí˜¸']||'' });
          });
          
prevUserMap.forEach((transactions, id) => {
            if (transactions.length === 0) {
              prevUser.set(id, 0);
              return;
            }
            
            const sortedTx = [...transactions].sort((a,b) => a.date.localeCompare(b.date));
            const lastDate = sortedTx[sortedTx.length - 1].date;
            const lastDateTxs = sortedTx.filter(tx => tx.date === lastDate);
            
            const lastOrderNos = [...new Set(lastDateTxs.filter(tx => tx.orderNo && tx.orderNo !== '-').map(tx => tx.orderNo))];
            
            let currentPoint = 0;
            if (lastOrderNos.length > 0) {
              const lastDateOrderTxs = sortedTx.filter(tx => tx.date === lastDate && lastOrderNos.includes(tx.orderNo));
              currentPoint = lastDateOrderTxs[lastDateOrderTxs.length - 1].total;
            } else {
              currentPoint = lastDateTxs[lastDateTxs.length - 1].total;
            }
            
            prevUser.set(id, currentPoint);
   // ë””ë²„ê¹…
            if (id === 'TMPDSc0a02a4998a6448') {
              console.log('TMPDSc0a02a4998a6448 prevUser ì„¤ì •:', currentPoint);
            }
          
          });
          
        map.forEach((u, id) => {
            if (prevUser.has(id)) {
              u.startPoint = prevUser.get(id);
                       
 // ë””ë²„ê¹…
              if (id === 'TMPDSc0a02a4998a6448') {
                console.log('TMPDSc0a02a4998a6448 startPoint ì„¤ì •:', u.startPoint);
              }
            }
          
          
          u.calculatedPoint = u.startPoint + u.earnedPoint + u.usedPoint + u.canceledPoint;
            u.mismatch = Math.abs(u.calculatedPoint - u.currentPoint) > 1;
          });
        }
        return Array.from(map.values()).filter(u => u.usedPoint !== 0 || u.earnedPoint !== 0 || u.canceledPoint !== 0).sort((a,b) => a.usedPoint - b.usedPoint);
      }, [monthlyAllData, realData, selectedMonth]);

const expiringPoint = useMemo(() => {
  console.log('realData ì´ ê±´ìˆ˜:', realData.length);
  console.log('data ì´ ê±´ìˆ˜:', data.length);
  if (!selectedMonth || !userStats || userStats.length === 0) return 0;
  
  const [year, month] = selectedMonth.split('-');
  const lastDay = new Date(Number(year), Number(month), 0).getDate();
  const endOfMonth = `${year}/${month}/${lastDay}`;
  
// ì‚¬ìš©ìë³„ ì”ì—¬ í¬ì¸íŠ¸ Map (realData ì „ì²´ë¡œ ê³„ì‚°)
  const userRemainingMap = new Map();
    const tempUserMap = new Map();
  realData
    .sort((a, b) => (a['ì²˜ë¦¬ì¼'] || '').localeCompare(b['ì²˜ë¦¬ì¼'] || ''))
    .forEach(r => {
      const userId = r['ê³ ê°ID'];
      const point = Number(r['í¬ì¸íŠ¸']) || 0;
      if (!tempUserMap.has(userId)) tempUserMap.set(userId, 0);
      tempUserMap.set(userId, tempUserMap.get(userId) + point);
    });
  
  tempUserMap.forEach((remaining, userId) => {
    if (remaining > 0) {
      userRemainingMap.set(userId, remaining);
    }
  });
  
  console.log('ì¬ê³„ì‚°ëœ userRemainingMap í¬ê¸°:', userRemainingMap.size);

 // â† ì—¬ê¸°ì— 3ì¤„ ì¶”ê°€!
  console.log('realDataì—ì„œ ì ë¦½ ê±°ë˜:', realData.filter(r => r['íƒ€ì…'] !== 'ì‚¬ìš©' && (Number(r['í¬ì¸íŠ¸']) || 0) > 0).length, 'ê±´');
  console.log('ì†Œë©¸ì¼ ìˆëŠ” ê±°ë˜:', realData.filter(r => r['ì†Œë©¸ ì˜ˆì •ì¼']).length, 'ê±´');
  console.log('userRemainingMap í¬ê¸°:', userRemainingMap.size);
  
  
  // realData ì „ì²´ì—ì„œ ì ë¦½ ê±°ë˜ë§Œ í•„í„°
  const allEarnTransactions = realData
    .filter(r => {
      const type = r['íƒ€ì…'];
      const point = Number(r['í¬ì¸íŠ¸']) || 0;
      const expireDate = r['ì†Œë©¸ ì˜ˆì •ì¼'] || '';
      const userId = r['ê³ ê°ID'];
      
      return type !== 'ì‚¬ìš©' && point > 0 && expireDate && 
             expireDate.substring(0,10) <= endOfMonth &&
             userRemainingMap.has(userId);
    })
    .map(r => ({
      userId: r['ê³ ê°ID'],
      point: Number(r['í¬ì¸íŠ¸']) || 0,
      expireDate: r['ì†Œë©¸ ì˜ˆì •ì¼'].substring(0,10)
    }))
    .sort((a, b) => a.expireDate.localeCompare(b.expireDate));
  
  console.log('ì „ì²´ ì ë¦½ ê±°ë˜:', allEarnTransactions.length, 'ê±´');
  
  // ì‚¬ìš©ìë³„ë¡œ ì†Œë©¸ ì˜ˆì • ê³„ì‚°
  const userExpiringMap = new Map();
  
  allEarnTransactions.forEach(tx => {
    const remaining = userRemainingMap.get(tx.userId);
    const alreadyExpiring = userExpiringMap.get(tx.userId) || 0;
    
    const canExpire = Math.min(tx.point, remaining - alreadyExpiring);
    if (canExpire > 0) {
      userExpiringMap.set(tx.userId, alreadyExpiring + canExpire);
    }
  });
  
  const total = Array.from(userExpiringMap.values()).reduce((s, v) => s + v, 0);
  console.log('ì´ ì†Œë©¸ì˜ˆì •:', total);
  
  return total;
}, [realData, selectedMonth, userStats]);
      
      const mismatchCount = useMemo(() => userStats.filter(u => u.mismatch).length, [userStats]);
      const filteredEarnByType = useMemo(() => !searchTerm ? earnByType : earnByType.filter(e => e.memo.toLowerCase().includes(searchTerm.toLowerCase())), [earnByType, searchTerm]);
      const filteredCompanyStats = useMemo(() => !searchTerm ? companyStats : companyStats.filter(c => c.company.toLowerCase().includes(searchTerm.toLowerCase())), [companyStats, searchTerm]);
      const filteredProductStats = useMemo(() => !searchTerm ? productStats : productStats.filter(p => p.productCode.toLowerCase().includes(searchTerm.toLowerCase()) || p.company.toLowerCase().includes(searchTerm.toLowerCase()) || p.productName.toLowerCase().includes(searchTerm.toLowerCase())), [productStats, searchTerm]);
      const filteredUserStats = useMemo(() => { let r = showMismatchOnly ? userStats.filter(u => u.mismatch) : userStats; if(!searchTerm) return r; const l = searchTerm.toLowerCase(); return r.filter(u => (u.name||'').toLowerCase().includes(l) || (u.id||'').toLowerCase().includes(l)); }, [userStats, searchTerm, showMismatchOnly]);
      const filteredCancelByType = useMemo(() => !searchTerm ? cancelByType : cancelByType.filter(c => c.memo.toLowerCase().includes(searchTerm.toLowerCase())), [cancelByType, searchTerm]);
      const filteredCancelUserStats = useMemo(() => { if(!searchTerm) return cancelUserStats; const l = searchTerm.toLowerCase(); return cancelUserStats.filter(u => (u.name||'').toLowerCase().includes(l) || (u.id||'').toLowerCase().includes(l)); }, [cancelUserStats, searchTerm]);

      const handleDownload = () => {
        let exportData = [];
        if (mainTab === 'use') {
          if (useSubTab === 'company') exportData = filteredCompanyStats.map(c => ({ êµ¬ë¶„: getCategoryLabel(c.category), ì—…ì²´ëª…: c.company, ì‚¬ìš©í¬ì¸íŠ¸: c.usedPoint, ì¸ì›: c.userCount }));
          else if (useSubTab === 'product') exportData = filteredProductStats.map(p => ({ ìƒí’ˆì½”ë“œ: p.productCode, ì…ì ì‚¬: p.company, ìƒí’ˆëª…: p.productName, ì‚¬ìš©í¬ì¸íŠ¸: p.usedPoint, ì¸ì›: p.userCount }));
          else if (useSubTab === 'user') exportData = filteredUserStats.map(u => ({ ì•„ì´ë””: u.id, ì´ë¦„: u.name, ì‹œì‘: u.startPoint, ì ë¦½: u.earnedPoint, ì‚¬ìš©: u.usedPoint, ì ë¦½ì·¨ì†Œ: u.canceledPoint, ì”ì—¬: u.currentPoint, ê²€ì¦: u.mismatch ? 'ë¶ˆì¼ì¹˜' : 'ì •ìƒ' }));
        } else if (mainTab === 'cancel') {
          if (cancelSubTab === 'type') exportData = filteredCancelByType.map(c => ({ ì·¨ì†Œìœ í˜•: c.memo, ì·¨ì†Œí¬ì¸íŠ¸: c.totalPoint, ì¸ì›: c.userCount }));
          else exportData = filteredCancelUserStats.map(u => ({ ì•„ì´ë””: u.id, ì´ë¦„: u.name, ì·¨ì†Œí¬ì¸íŠ¸: u.totalPoint }));
        }
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        XLSX.writeFile(wb, `í¬ì¸íŠ¸_${mainTab}_${new Date().toISOString().slice(0,10)}.xlsx`);
      };

      const colors = {
        primary: '#1e40af',
        success: '#059669',
        danger: '#dc2626',
        warning: '#f59e0b',
        cancel: '#8b5cf6',
        muted: '#6b7280',
        border: '#d1d5db',
        light: '#f3f4f6',
        dark: '#1f2937'
      };

      const tooltips = {
        carryover: 'ì „ì›”ì´ì›”: ì§€ë‚œë‹¬ ì”ì—¬ì™€ ë™ì¼í•œ ê¸ˆì•¡ì…ë‹ˆë‹¤. ì§€ë‚œë‹¬ ë§ ê¸°ì¤€ ê° ì‚¬ìš©ìì˜ ë§ˆì§€ë§‰ í† íƒˆí¬ì¸íŠ¸ í•©ê³„ì…ë‹ˆë‹¤.',
        earned: 'ì ë¦½: ì´ë²ˆ ë‹¬ì— ìƒˆë¡œ ì ë¦½ëœ í¬ì¸íŠ¸ ì´ì•¡ì…ë‹ˆë‹¤. (ì´ë²¤íŠ¸, êµ¬ë… í˜œíƒ ë“±)',
        used: 'ì‚¬ìš©: ì´ë²ˆ ë‹¬ì— ìƒí’ˆ êµ¬ë§¤ ë“±ìœ¼ë¡œ ì‹¤ì œ ì‚¬ìš©ëœ í¬ì¸íŠ¸ ì´ì•¡ì…ë‹ˆë‹¤.',
        canceled: 'ì ë¦½ì·¨ì†Œ: ì •ê¸°êµ¬ë… ì·¨ì†Œ ë“±ìœ¼ë¡œ CSì—ì„œ ì°¨ê°í•œ í¬ì¸íŠ¸ ì´ì•¡ì…ë‹ˆë‹¤.',
        balance: 'ì”ì—¬: ì „ì›”ì´ì›” + ì ë¦½ + ì‚¬ìš© + ì ë¦½ì·¨ì†Œë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. ì´ë²ˆ ë‹¬ ë§ ê¸°ì¤€ ì˜ˆìƒ ì”ì—¬ í¬ì¸íŠ¸ì…ë‹ˆë‹¤.',
        expiring: 'ì†Œë©¸ì˜ˆì •: ì´ë²ˆ ë‹¬ ë§ê¹Œì§€ ì†Œë©¸ ì˜ˆì •ì¸ í¬ì¸íŠ¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ë‹¬ì—ëŠ” ì´ ê¸ˆì•¡ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.'
      };

      const cardStyle = { 
        flex: 1, 
        padding: '16px 20px', 
        backgroundColor: 'white', 
        borderRadius: '8px', 
        borderLeft: '4px solid', 
        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
        minWidth: '160px'
      };

      const btnStyle = {
        padding: '8px 16px',
        border: 'none',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '13px',
        fontWeight: '500',
        transition: 'all 0.2s',
        backgroundColor: '#1e40af',
        color: 'white'
      };

      const inputStyle = {
        padding: '8px 12px',
        border: '1px solid ' + colors.border,
        borderRadius: '6px',
        fontSize: '13px',
        outline: 'none',
        transition: 'border-color 0.2s'
      };

      const tabStyle = (isActive) => ({
        padding: '10px 20px',
        border: 'none',
        background: isActive ? '#1e40af' : 'transparent',
        color: isActive ? 'white' : colors.muted,
        cursor: 'pointer',
        fontSize: '14px',
        fontWeight: '500',
        borderRadius: '6px 6px 0 0',
        transition: 'all 0.2s'
      });

      const subTabStyle = (tab) => ({
        padding: '12px 24px',
        border: 'none',
        background: (mainTab === 'use' ? useSubTab : cancelSubTab) === tab ? 'white' : 'transparent',
        color: (mainTab === 'use' ? useSubTab : cancelSubTab) === tab ? colors.dark : colors.muted,
        cursor: 'pointer',
        fontSize: '14px',
        fontWeight: (mainTab === 'use' ? useSubTab : cancelSubTab) === tab ? '600' : '400',
        borderBottom: (mainTab === 'use' ? useSubTab : cancelSubTab) === tab ? '3px solid #1e40af' : '3px solid transparent',
        transition: 'all 0.2s'
      });

      const thStyle = {
        padding: '12px 16px',
        backgroundColor: '#f9fafb',
        borderBottom: '2px solid ' + colors.border,
        textAlign: 'left',
        fontSize: '12px',
        fontWeight: '600',
        color: colors.dark,
        textTransform: 'uppercase',
        letterSpacing: '0.05em'
      };

      const tdStyle = {
        padding: '12px 16px',
        borderBottom: '1px solid #f3f4f6',
        fontSize: '13px',
        color: '#374151'
      };

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
      {/* Header */}
          <div style={{ 
            backgroundColor: '#1e293b', 
            color: 'white', 
            padding: '16px 32px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <h1 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>í¬ì¸íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              {fileName && (
                <span style={{ fontSize: '13px', color: '#94a3b8' }}>ğŸ“„ {fileName}</span>
              )}
              
              {/* Google Sheets */}
            {!isGoogleSignedIn ? (
                <button onClick={handleGoogleSignIn} style={{ ...btnStyle, backgroundColor: '#4285f4' }}>
                  Google ë¡œê·¸ì¸
                </button>
              ) : (
                <>
                 <button onClick={() => {
                    const newUrl = prompt('êµ¬ê¸€ ì‹œíŠ¸ URLì„ ì…ë ¥í•˜ì„¸ìš”', sheetUrl);
                    if (newUrl) {
                      setSheetUrl(newUrl);
                      localStorage.setItem('savedSheetUrl', newUrl);
                    }
                  }} style={{ ...btnStyle, backgroundColor: '#f59e0b' }}>
                    ì‹œíŠ¸ ë³€ê²½
                  </button>
                  <button onClick={handleLoadSheet} style={{ ...btnStyle, backgroundColor: '#34a853' }}>
                    ì‹œíŠ¸ ë¡œë“œ
                  </button>
                  <button onClick={() => {
                    localStorage.removeItem('googleAccessToken');
                    localStorage.removeItem('savedSheetUrl');
                    setIsGoogleSignedIn(false);
                    setGoogleAccessToken('');
                    setSheetUrl('');
                    setData([]);
                  }} style={{ ...btnStyle, backgroundColor: '#dc2626' }}>
                    ë¡œê·¸ì•„ì›ƒ
                  </button>
                </>
              )}

              
              {/* íŒŒì¼ ì—…ë¡œë“œ */}
              <label style={{ ...btnStyle, cursor: 'pointer', display: 'inline-block' }}>
                íŒŒì¼ ì—…ë¡œë“œ
                <input type="file" accept=".xlsx,.xls" onChange={handleFileUpload} style={{ display: 'none' }} />
              </label>
            </div>
          </div>

          {/* Main Content */}
          <div style={{ flex: 1, padding: '24px 32px', maxWidth: '1600px', width: '100%', margin: '0 auto' }}>
            {data.length > 0 && (
              <Fragment>
                {/* Filters */}
                <div style={{ 
                  backgroundColor: 'white', 
                  borderRadius: '8px', 
                  padding: '16px 20px', 
                  marginBottom: '20px',
                  boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                  display: 'flex',
                  gap: '12px',
                  alignItems: 'center',
                  flexWrap: 'wrap'
                }}>
                  <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} style={{ ...inputStyle, minWidth: '150px' }}>
                    <option value="">ì „ì²´ ê¸°ê°„</option>
                    {availableMonths.map(m => <option key={m} value={m}>{m}</option>)}
                  </select>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px', cursor: 'pointer', color: colors.muted }}>
                    <input type="checkbox" checked={showCanceled} onChange={(e) => setShowCanceled(e.target.checked)} />
                    ì·¨ì†Œì™„ë£Œ í¬í•¨
                    {canceledCount > 0 && <span style={{ color: colors.warning }}>({canceledCount}ê±´)</span>}
                  </label>
                  <div style={{ fontSize: '13px', color: colors.muted, marginLeft: 'auto' }}>
                    ì´ {realData.length.toLocaleString()}ê±´
                  </div>
                </div>

                {/* Stats Cards */}
                <div style={{ display: 'flex', gap: '16px', marginBottom: '24px', flexWrap: 'wrap' }}>
                  <div style={{ ...cardStyle, borderLeftColor: colors.muted }}>
                    <div style={{ fontSize: '12px', color: colors.muted, marginBottom: '4px', fontWeight: '500' }}>ì „ì›”ì´ì›”</div>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#374151', marginBottom: '8px' }}>{monthlyTotals.carryover.toLocaleString()}</div>
                    <div style={{ fontSize: '10px', color: colors.muted, lineHeight: '1.4', opacity: 0.8 }}>{tooltips.carryover}</div>
                  </div>

                  <div style={{ ...cardStyle, borderLeftColor: colors.success }}>
                    <div style={{ fontSize: '12px', color: colors.muted, marginBottom: '4px', fontWeight: '500' }}>ì ë¦½ ({earnData.length})</div>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: colors.success, marginBottom: '8px' }}>+{monthlyTotals.earned.toLocaleString()}</div>
                    <div style={{ fontSize: '10px', color: colors.muted, lineHeight: '1.4', opacity: 0.8 }}>{tooltips.earned}</div>
                  </div>

                  <div style={{ ...cardStyle, borderLeftColor: colors.danger }}>
                    <div style={{ fontSize: '12px', color: colors.muted, marginBottom: '4px', fontWeight: '500' }}>ì‚¬ìš© ({useData.length})</div>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: colors.danger, marginBottom: '8px' }}>{monthlyTotals.used.toLocaleString()}</div>
                    <div style={{ fontSize: '10px', color: colors.muted, lineHeight: '1.4', opacity: 0.8 }}>{tooltips.used}</div>
                  </div>

                  <div style={{ ...cardStyle, borderLeftColor: colors.cancel }}>
                    <div style={{ fontSize: '12px', color: colors.muted, marginBottom: '4px', fontWeight: '500' }}>ì ë¦½ì·¨ì†Œ ({cancelData.length})</div>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: colors.cancel, marginBottom: '8px' }}>{monthlyTotals.canceled.toLocaleString()}</div>
                    <div style={{ fontSize: '10px', color: colors.muted, lineHeight: '1.4', opacity: 0.8 }}>{tooltips.canceled}</div>
                  </div>

                  <div style={{ ...cardStyle, borderLeftColor: colors.primary, backgroundColor: '#eff6ff' }}>
                    <div style={{ fontSize: '12px', color: colors.muted, marginBottom: '4px', fontWeight: '500' }}>ì”ì—¬</div>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: colors.primary, marginBottom: '8px' }}>{monthlyTotals.balance.toLocaleString()}</div>
                    <div style={{ fontSize: '10px', color: colors.muted, lineHeight: '1.4', opacity: 0.8 }}>{tooltips.balance}</div>
                  </div>

                  <div style={{ ...cardStyle, borderLeftColor: colors.warning, backgroundColor: '#fffbeb' }}>
                    <div style={{ fontSize: '12px', color: colors.warning, marginBottom: '4px', fontWeight: '500' }}>ì†Œë©¸ì˜ˆì •</div>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: colors.warning, marginBottom: '8px' }}>{expiringPoint.toLocaleString()}</div>
                    <div style={{ fontSize: '10px', color: colors.muted, lineHeight: '1.4', opacity: 0.8 }}>{tooltips.expiring}</div>
                  </div>
                </div>

                {/* Tabs */}
                <div style={{ display: 'flex', gap: '4px', marginBottom: '16px' }}>
                  <button style={tabStyle(mainTab === 'earn')} onClick={() => setMainTab('earn')}>
                    ì ë¦½ ë‚´ì—­
                  </button>
                  <button style={tabStyle(mainTab === 'use')} onClick={() => setMainTab('use')}>
                    ì‚¬ìš© ë‚´ì—­
                  </button>
                  <button style={tabStyle(mainTab === 'cancel')} onClick={() => setMainTab('cancel')}>
                    ì·¨ì†Œ ë‚´ì—­
                  </button>
                </div>

                {/* Earn Tab Content */}
                {mainTab === 'earn' && (
                  <div style={{ backgroundColor: 'white', borderRadius: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', overflow: 'hidden' }}>
                    <div style={{ padding: '12px 16px', backgroundColor: '#f9fafb', borderBottom: '1px solid ' + colors.border, display: 'flex', gap: '12px', alignItems: 'center' }}>
                      <input type="text" placeholder="ì ë¦½ ìœ í˜• ê²€ìƒ‰..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, flex: 1 }} />
                      <span style={{ fontSize: '13px', color: colors.muted, fontWeight: '500' }}>{filteredEarnByType.length}ê°œ ìœ í˜•</span>
                    </div>
                    <div style={{ maxHeight: 'calc(100vh - 480px)', overflowY: 'auto' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ position: 'sticky', top: 0, zIndex: 1 }}>
                          <tr>
                            <th style={{ ...thStyle, width: '30px' }}></th>
                            <th style={thStyle}>ì ë¦½ ìœ í˜•</th>
                            <th style={{ ...thStyle, textAlign: 'right', width: '140px' }}>í¬ì¸íŠ¸</th>
                            <th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>ì¸ì›</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredEarnByType.map((e, i) => (
                            <Fragment key={i}>
                              <tr style={{ cursor: 'pointer', backgroundColor: expandedEarn === i ? '#f9fafb' : (i % 2 === 0 ? 'white' : '#fafafa') }} onClick={() => setExpandedEarn(expandedEarn === i ? null : i)}>
                                <td style={tdStyle}>{expandedEarn === i ? 'â–¼' : 'â–¶'}</td>
                                <td style={{ ...tdStyle, fontStyle: e.isCancelRefund ? 'italic' : 'normal', color: e.isCancelRefund ? colors.muted : '#374151' }}>{e.memo}</td>
                                <td style={{ ...tdStyle, textAlign: 'right', color: e.isCancelRefund ? colors.warning : colors.success, fontWeight: '600', fontSize: '14px' }}>+{e.totalPoint.toLocaleString()}</td>
                                <td style={{ ...tdStyle, textAlign: 'right', color: colors.muted }}>{e.userCount}</td>
                              </tr>
                              {expandedEarn === i && (
                                <tr>
                                  <td colSpan={4} style={{ padding: '0', backgroundColor: '#f9fafb' }}>
                                    <div style={{ padding: '16px 20px' }}>
                                      <table style={{ width: '100%', fontSize: '12px' }}>
                                        <thead>
                                          <tr>
                                            <th style={{ padding: '8px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, fontSize: '11px', color: colors.muted }}>ì¼ì</th>
                                            <th style={{ padding: '8px 12px', textAlign: 'right', borderBottom: '1px solid ' + colors.border, fontSize: '11px', color: colors.muted }}>í¬ì¸íŠ¸</th>
                                            <th style={{ padding: '8px 12px', textAlign: 'right', borderBottom: '1px solid ' + colors.border, fontSize: '11px', color: colors.muted }}>ê±´ìˆ˜</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {e.dateList.map((d, j) => (
                                            <tr key={j}>
                                              <td style={{ padding: '8px 12px' }}>{d.date}</td>
                                              <td style={{ padding: '8px 12px', textAlign: 'right', color: colors.success, fontWeight: '500' }}>+{d.point.toLocaleString()}</td>
                                              <td style={{ padding: '8px 12px', textAlign: 'right' }}>{d.count}</td>
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  </td>
                                </tr>
                              )}
                            </Fragment>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Use Tab Content */}
                {mainTab === 'use' && (
                  <div style={{ backgroundColor: 'white', borderRadius: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', overflow: 'hidden' }}>
                    <div style={{ display: 'flex', borderBottom: '2px solid #f3f4f6' }}>
                      <button style={subTabStyle('company')} onClick={() => { setUseSubTab('company'); setSearchTerm(''); }}>ì—…ì²´ë³„</button>
                      <button style={subTabStyle('product')} onClick={() => { setUseSubTab('product'); setSearchTerm(''); }}>ìƒí’ˆë³„</button>
                      <button style={subTabStyle('user')} onClick={() => { setUseSubTab('user'); setSearchTerm(''); }}>
                        ì‚¬ìš©ìë³„ {mismatchCount > 0 && <span style={{ color: colors.danger, marginLeft: '4px', fontSize: '12px' }}>({mismatchCount})</span>}
                      </button>
                    </div>
                    <div style={{ padding: '12px 16px', display: 'flex', gap: '10px', borderBottom: '1px solid ' + colors.border, alignItems: 'center', backgroundColor: '#f9fafb' }}>
                      <input type="text" placeholder={useSubTab === 'company' ? 'ì—…ì²´ëª… ê²€ìƒ‰...' : useSubTab === 'product' ? 'ìƒí’ˆì½”ë“œ/ì…ì ì‚¬/ìƒí’ˆëª… ê²€ìƒ‰...' : 'ì´ë¦„/ID ê²€ìƒ‰...'} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, flex: 1 }} />
                      {useSubTab === 'user' && mismatchCount > 0 && (
                        <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px', cursor: 'pointer', whiteSpace: 'nowrap', color: colors.muted }}>
                          <input type="checkbox" checked={showMismatchOnly} onChange={(e) => setShowMismatchOnly(e.target.checked)} />
                          ë¶ˆì¼ì¹˜ë§Œ
                        </label>
                      )}
                      <button onClick={handleDownload} style={{ ...btnStyle, backgroundColor: colors.primary }}>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>

                    {useSubTab === 'company' && (
                      <Fragment>
                        <div style={{ padding: '12px 16px', backgroundColor: '#f9fafb', borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted }}>
                          <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', fontWeight: '500' }}>
                            <span>{filteredCompanyStats.length}ê°œ ì—…ì²´</span>
                            <span style={{ color: '#7c3aed' }}>â— ì •ê¸°êµ¬ë…: {categoryTotals.subscription.toLocaleString()}</span>
                            <span style={{ color: '#0891b2' }}>â— ë””ì§€í„¸ì½˜í…ì¸ : {categoryTotals.digital.toLocaleString()}</span>
                            <span style={{ color: colors.danger }}>â— ì…ì ì‚¬: {categoryTotals.store.toLocaleString()}</span>
                          </div>
                        </div>
                        <div style={{ maxHeight: 'calc(100vh - 450px)', overflowY: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ position: 'sticky', top: 0, zIndex: 1 }}>
                              <tr>
                                <th style={{ ...thStyle, width: '100px' }}>êµ¬ë¶„</th>
                                <th style={thStyle}>ì—…ì²´ëª…</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '140px' }}>ì‚¬ìš©í¬ì¸íŠ¸</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>ì¸ì›</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredCompanyStats.map((c, i) => (
                                <tr key={i} style={{ backgroundColor: i % 2 === 0 ? 'white' : '#fafafa' }}>
                                  <td style={{ ...tdStyle, fontSize: '11px' }}>
                                    {c.category === 'subscription' && <span style={{ padding: '3px 8px', borderRadius: '4px', backgroundColor: '#f3e8ff', color: '#7c3aed', fontWeight: '500' }}>ì •ê¸°êµ¬ë…</span>}
                                    {c.category === 'digital' && <span style={{ padding: '3px 8px', borderRadius: '4px', backgroundColor: '#e0f2fe', color: '#0891b2', fontWeight: '500' }}>ë””ì§€í„¸</span>}
                                    {c.category === 'store' && <span style={{ padding: '3px 8px', borderRadius: '4px', backgroundColor: '#fef2f2', color: colors.danger, fontWeight: '500' }}>ì…ì ì‚¬</span>}
                                    {c.category === 'etc' && <span style={{ padding: '3px 8px', borderRadius: '4px', backgroundColor: '#f1f5f9', color: colors.muted, fontWeight: '500' }}>ê¸°íƒ€</span>}
                                  </td>
                                  <td style={{ ...tdStyle, color: c.company === 'CS ìˆ˜ë™ì°¨ê°' ? colors.muted : '#374151', fontStyle: c.company === 'CS ìˆ˜ë™ì°¨ê°' ? 'italic' : 'normal', fontWeight: '500' }}>{c.company}</td>
                                  <td style={{ ...tdStyle, textAlign: 'right', color: colors.danger, fontWeight: '600', fontSize: '14px' }}>{c.usedPoint.toLocaleString()}</td>
                                  <td style={{ ...tdStyle, textAlign: 'right', color: colors.muted }}>{c.userCount}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </Fragment>
                    )}

                    {useSubTab === 'product' && (
                      <Fragment>
                        <div style={{ padding: '12px 16px', backgroundColor: '#f9fafb', borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted, fontWeight: '500' }}>
                          {filteredProductStats.length}ê°œ ìƒí’ˆ
                        </div>
                        <div style={{ maxHeight: 'calc(100vh - 410px)', overflowY: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ position: 'sticky', top: 0, zIndex: 1 }}>
                              <tr>
                                <th style={{ ...thStyle, width: '110px' }}>ìƒí’ˆì½”ë“œ</th>
                                <th style={{ ...thStyle, width: '130px' }}>ì…ì ì‚¬</th>
                                <th style={thStyle}>ìƒí’ˆëª…</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '130px' }}>ì‚¬ìš©í¬ì¸íŠ¸</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '70px' }}>ì¸ì›</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredProductStats.map((p, i) => (
                                <tr key={i} style={{ backgroundColor: i % 2 === 0 ? 'white' : '#fafafa' }}>
                                  <td style={{ ...tdStyle, fontFamily: 'monospace', fontSize: '11px', color: colors.muted }}>{p.productCode}</td>
                                  <td style={{ ...tdStyle, fontSize: '12px', color: p.company === 'CS ìˆ˜ë™ì°¨ê°' ? colors.muted : '#374151', fontStyle: p.company === 'CS ìˆ˜ë™ì°¨ê°' ? 'italic' : 'normal' }}>{p.company}</td>
                                  <td style={{ ...tdStyle, maxWidth: '350px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title={p.productName}>{p.productName}</td>
                                  <td style={{ ...tdStyle, textAlign: 'right', color: colors.danger, fontWeight: '600', fontSize: '14px' }}>{p.usedPoint.toLocaleString()}</td>
                                  <td style={{ ...tdStyle, textAlign: 'right', color: colors.muted }}>{p.userCount}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </Fragment>
                    )}

                    {useSubTab === 'user' && (
                      <Fragment>
                        <div style={{ padding: '12px 16px', backgroundColor: '#f9fafb', borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted, display: 'flex', justifyContent: 'space-between', fontWeight: '500' }}>
                          <span>{filteredUserStats.length}ëª…</span>
                          {mismatchCount > 0 && !showMismatchOnly && (
                            <span style={{ color: colors.danger }}>ë¶ˆì¼ì¹˜ {mismatchCount}ëª…</span>
                          )}
                        </div>
                        <div style={{ maxHeight: 'calc(100vh - 410px)', overflowY: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ position: 'sticky', top: 0, zIndex: 1 }}>
                              <tr>
                                <th style={{ ...thStyle, width: '35px' }}></th>
                                <th style={thStyle}>ì•„ì´ë””</th>
                                <th style={thStyle}>ì´ë¦„</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '90px' }}>ì‹œì‘</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>ì ë¦½</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>ì‚¬ìš©</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>ì ë¦½ì·¨ì†Œ</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '90px' }}>ì”ì—¬</th>
                                <th style={{ ...thStyle, textAlign: 'center', width: '60px' }}>ê²€ì¦</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredUserStats.map((u, i) => (
                                <Fragment key={i}>
                                  <tr style={{ cursor: 'pointer', backgroundColor: u.mismatch ? '#fef2f2' : (expandedUser === i ? '#f9fafb' : (i % 2 === 0 ? 'white' : '#fafafa')) }} onClick={() => setExpandedUser(expandedUser === i ? null : i)}>
                                    <td style={tdStyle}>{expandedUser === i ? 'â–¼' : 'â–¶'}</td>
                                    <td style={{ ...tdStyle, fontFamily: 'monospace', fontSize: '11px', color: colors.muted }}>{u.id}</td>
                                    <td style={{ ...tdStyle, fontWeight: '600' }}>{maskName(u.name)}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', color: colors.muted }}>{u.startPoint.toLocaleString()}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', color: colors.success, fontWeight: '500' }}>+{u.earnedPoint.toLocaleString()}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', color: colors.danger, fontWeight: '600' }}>{u.usedPoint.toLocaleString()}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', color: colors.cancel, fontWeight: '600' }}>{u.canceledPoint.toLocaleString()}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', fontWeight: '700', color: colors.primary, fontSize: '14px' }}>{u.currentPoint.toLocaleString()}</td>
                                    <td style={{ ...tdStyle, textAlign: 'center' }}>
                                      {u.mismatch ? <span style={{ color: colors.danger, fontSize: '16px', fontWeight: 'bold' }}>âœ—</span> : <span style={{ color: colors.success, fontSize: '16px', fontWeight: 'bold' }}>âœ“</span>}
                                    </td>
                                  </tr>
                                  {expandedUser === i && (
                                    <tr>
                                      <td colSpan={9} style={{ padding: '0', backgroundColor: '#f9fafb' }}>
                                        <div style={{ padding: '16px 20px' }}>
                                          <div style={{ fontSize: '11px', color: colors.muted, marginBottom: '12px', padding: '8px 12px', backgroundColor: 'white', borderRadius: '6px', display: 'inline-block', border: '1px solid ' + colors.border }}>
                                            <strong>ê³„ì‚°ì‹:</strong> {u.startPoint.toLocaleString()} + {u.earnedPoint.toLocaleString()} + ({u.usedPoint.toLocaleString()}) + ({u.canceledPoint.toLocaleString()}) = {u.calculatedPoint.toLocaleString()}
                                            {u.mismatch && <span style={{ color: colors.danger, marginLeft: '12px', fontWeight: 'bold' }}>â‰  ì‹¤ì œ {u.currentPoint.toLocaleString()}</span>}
                                          </div>
                                          <table style={{ width: '100%', fontSize: '12px', backgroundColor: 'white', borderRadius: '6px', overflow: 'hidden' }}>
                                            <thead>
                                              <tr style={{ backgroundColor: '#f3f4f6' }}>
                                                <th style={{ padding: '10px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, fontSize: '11px', fontWeight: '600', color: colors.dark }}>ì¼ì‹œ</th>
                                                <th style={{ padding: '10px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, fontSize: '11px', fontWeight: '600', color: colors.dark }}>íƒ€ì…</th>
                                                <th style={{ padding: '10px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, fontSize: '11px', fontWeight: '600', color: colors.dark }}>ì£¼ë¬¸ë²ˆí˜¸</th>
                                                <th style={{ padding: '10px 12px', textAlign: 'right', borderBottom: '1px solid ' + colors.border, fontSize: '11px', fontWeight: '600', color: colors.dark }}>í¬ì¸íŠ¸</th>
                                                <th style={{ padding: '10px 12px', textAlign: 'right', borderBottom: '1px solid ' + colors.border, fontSize: '11px', fontWeight: '600', color: colors.dark }}>ì”ì•¡</th>
                                                <th style={{ padding: '10px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, fontSize: '11px', fontWeight: '600', color: colors.dark }}>ë©”ëª¨</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {[...u.transactions].sort((a, b) => a.date.localeCompare(b.date)).map((tx, j) => (
                                                <tr key={j} style={{ backgroundColor: tx.status === 'ì·¨ì†Œì™„ë£Œ' ? '#fef2f2' : 'transparent' }}>
                                                  <td style={{ padding: '10px 12px', borderBottom: '1px solid #f3f4f6' }}>{tx.date}</td>
                                                  <td style={{ padding: '10px 12px', borderBottom: '1px solid #f3f4f6' }}>
                                                    <span style={{ 
                                                      padding: '3px 8px', 
                                                      borderRadius: '4px', 
                                                      fontSize: '10px', 
                                                      fontWeight: '500', 
                                                      backgroundColor: tx.type === 'ì ë¦½ì·¨ì†Œ' ? '#f3e8ff' : (tx.type === 'ì‚¬ìš©' ? '#fef2f2' : '#f0fdf4'), 
                                                      color: tx.type === 'ì ë¦½ì·¨ì†Œ' ? colors.cancel : (tx.type === 'ì‚¬ìš©' ? colors.danger : colors.success) 
                                                    }}>{tx.type}</span>
                                                    {tx.status === 'ì·¨ì†Œì™„ë£Œ' && <span style={{ marginLeft: '6px', fontSize: '10px', color: colors.muted }}>(ì·¨ì†Œ)</span>}
                                                  </td>
                                                  <td style={{ padding: '10px 12px', fontFamily: 'monospace', fontSize: '11px', color: colors.muted, borderBottom: '1px solid #f3f4f6' }}>{tx.orderNo || '-'}</td>
                                                  <td style={{ padding: '10px 12px', textAlign: 'right', color: tx.point < 0 ? (tx.type === 'ì ë¦½ì·¨ì†Œ' ? colors.cancel : colors.danger) : colors.success, fontWeight: '600', borderBottom: '1px solid #f3f4f6' }}>{tx.point > 0 ? '+' : ''}{tx.point.toLocaleString()}</td>
                                                  <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: '500', borderBottom: '1px solid #f3f4f6' }}>{tx.total.toLocaleString()}</td>
                                                  <td style={{ padding: '10px 12px', maxWidth: '250px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', color: colors.muted, borderBottom: '1px solid #f3f4f6' }} title={tx.memo}>{tx.memo || '-'}</td>
                                                </tr>
                                              ))}
                                            </tbody>
                                          </table>
                                        </div>
                                      </td>
                                    </tr>
                                  )}
                                </Fragment>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </Fragment>
                    )}
                  </div>
                )}

                {/* Cancel Tab Content */}
                {mainTab === 'cancel' && (
                  <div style={{ backgroundColor: 'white', borderRadius: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', overflow: 'hidden' }}>
                    <div style={{ display: 'flex', borderBottom: '2px solid #f3f4f6' }}>
                      <button style={subTabStyle('type')} onClick={() => { setCancelSubTab('type'); setSearchTerm(''); }}>ìœ í˜•ë³„</button>
                      <button style={subTabStyle('user')} onClick={() => { setCancelSubTab('user'); setSearchTerm(''); }}>ì‚¬ìš©ìë³„</button>
                    </div>
                    <div style={{ padding: '12px 16px', display: 'flex', gap: '10px', borderBottom: '1px solid ' + colors.border, alignItems: 'center', backgroundColor: '#f9fafb' }}>
                      <input type="text" placeholder={cancelSubTab === 'type' ? 'ì·¨ì†Œ ìœ í˜• ê²€ìƒ‰...' : 'ì´ë¦„/ID ê²€ìƒ‰...'} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, flex: 1 }} />
                      <button onClick={handleDownload} style={{ ...btnStyle, backgroundColor: colors.primary }}>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>

                    {cancelSubTab === 'type' && (
                      <Fragment>
                        <div style={{ padding: '12px 16px', backgroundColor: '#f9fafb', borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted, fontWeight: '500' }}>
                          {filteredCancelByType.length}ê°œ ìœ í˜•
                        </div>
                        <div style={{ maxHeight: 'calc(100vh - 410px)', overflowY: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ position: 'sticky', top: 0, zIndex: 1 }}>
                              <tr>
                                <th style={{ ...thStyle, width: '30px' }}></th>
                                <th style={thStyle}>ì·¨ì†Œ ìœ í˜•</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '140px' }}>ì·¨ì†Œ í¬ì¸íŠ¸</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>ì¸ì›</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredCancelByType.map((c, i) => (
                                <Fragment key={i}>
                                  <tr style={{ cursor: 'pointer', backgroundColor: expandedCancel === i ? '#f9fafb' : (i % 2 === 0 ? 'white' : '#fafafa') }} onClick={() => setExpandedCancel(expandedCancel === i ? null : i)}>
                                    <td style={tdStyle}>{expandedCancel === i ? 'â–¼' : 'â–¶'}</td>
                                    <td style={{ ...tdStyle, fontWeight: '500' }}>{c.memo}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', color: colors.cancel, fontWeight: '600', fontSize: '14px' }}>{c.totalPoint.toLocaleString()}</td>
                                    <td style={{ ...tdStyle, textAlign: 'right', color: colors.muted }}>{c.userCount}</td>
                                  </tr>
                                  {expandedCancel === i && (
                                    <tr>
                                      <td colSpan={4} style={{ padding: '0', backgroundColor: '#f9fafb' }}>
                                        <div style={{ padding: '16px 20px' }}>
                                          <table style={{ width: '100%', fontSize: '12px' }}>
                                            <thead>
                                              <tr>
                                                <th style={{ padding: '8px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, fontSize: '11px', color: colors.muted }}>ì¼ì</th>
                                                <th style={{ padding: '8px 12px', textAlign: 'right', borderBottom: '1px solid ' + colors.border, fontSize: '11px', color: colors.muted }}>í¬ì¸íŠ¸</th>
                                                <th style={{ padding: '8px 12px', textAlign: 'right', borderBottom: '1px solid ' + colors.border, fontSize: '11px', color: colors.muted }}>ê±´ìˆ˜</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {c.dateList.map((d, j) => (
                                                <tr key={j}>
                                                  <td style={{ padding: '8px 12px' }}>{d.date}</td>
                                                  <td style={{ padding: '8px 12px', textAlign: 'right', color: colors.cancel, fontWeight: '500' }}>{d.point.toLocaleString()}</td>
                                                  <td style={{ padding: '8px 12px', textAlign: 'right' }}>{d.count}</td>
                                                </tr>
                                              ))}
                                            </tbody>
                                          </table>
                                        </div>
                                      </td>
                                    </tr>
                                  )}
                                </Fragment>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </Fragment>
                    )}

                    {cancelSubTab === 'user' && (
                      <Fragment>
                        <div style={{ padding: '12px 16px', backgroundColor: '#f9fafb', borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted, fontWeight: '500' }}>
                          {filteredCancelUserStats.length}ëª…
                        </div>
                        <div style={{ maxHeight: 'calc(100vh - 410px)', overflowY: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead style={{ position: 'sticky', top: 0, zIndex: 1 }}>
                              <tr>
                                <th style={thStyle}>ì•„ì´ë””</th>
                                <th style={thStyle}>ì´ë¦„</th>
                                <th style={{ ...thStyle, textAlign: 'right', width: '140px' }}>ì·¨ì†Œ í¬ì¸íŠ¸</th>
                              </tr>
                            </thead>
                            <tbody>
                              {filteredCancelUserStats.map((u, i) => (
                                <tr key={i} style={{ backgroundColor: i % 2 === 0 ? 'white' : '#fafafa' }}>
                                  <td style={{ ...tdStyle, fontFamily: 'monospace', fontSize: '11px', color: colors.muted }}>{u.id}</td>
                                  <td style={{ ...tdStyle, fontWeight: '600' }}>{maskName(u.name)}</td>
                                  <td style={{ ...tdStyle, textAlign: 'right', color: colors.cancel, fontWeight: '600', fontSize: '14px' }}>{u.totalPoint.toLocaleString()}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </Fragment>
                    )}
                  </div>
                )}
              </Fragment>
            )}

            {data.length === 0 && (
              <div style={{ 
                backgroundColor: 'white', 
                borderRadius: '8px', 
                padding: '80px 40px', 
                textAlign: 'center', 
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)' 
              }}>
                <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.3 }}>ğŸ“Š</div>
                <p style={{ color: colors.muted, margin: 0, fontSize: '15px' }}>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í¬ì¸íŠ¸ ë‚´ì—­ì„ ë¶„ì„í•˜ì„¸ìš”</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>













































