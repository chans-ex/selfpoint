
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ν¬μΈνΈ κ΄€λ¦¬</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body style="margin:0; background:#f8f9fa;">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, Fragment } = React;

    const TEST_IDS = [
      'TMPDScb32d04b64d94a9', 'TMPDS4abdb524d673492', 'TMPDS5254acb93dbe46c',
      'TMPDSa2686c826a28485', 'TMPDS6a4757e6a3c34cc', 'TMPDSc53c81cb026f488',
      'TMPDS067d9b743d17463', 'TMPDS43098c59653c486', 'TMPDS21c02640426e436',
      'TMPDS8b09cd30f54e476', 'TMPDSd27bf78fb8e546a', 'TMPDSd5034a6fbad64be',
      'TMPDS77970861beae492', 'TMPDS28c045ff094843a', 'TMPDS4ccba6a2a15040e',
      'TMPDS731a0fb561354e0', 'TMPDS9fb6acec8fe14b8', 'TMPDSa9f21742c6e1b84',
      'TMPDSe5a4afa77d6346f', 'TMPDS1e7083124613423', 'TMPDSabb9d72cecd244d',
      'TMPDS4ecbd717abc5486', 'TMPDS87a0f273848f4d2', 'TMPDSc788cf5178fa428',
      'dongatest',
    ];

    function App() {
      const [data, setData] = useState([]);
      const [fileName, setFileName] = useState('');
      const [mainTab, setMainTab] = useState('earn');
      const [useSubTab, setUseSubTab] = useState('company');
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedMonth, setSelectedMonth] = useState('');
      const [showCanceled, setShowCanceled] = useState(false);
      const [expandedUser, setExpandedUser] = useState(null);
      const [expandedEarn, setExpandedEarn] = useState(null);
      const [showMismatchOnly, setShowMismatchOnly] = useState(false);

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setFileName(file.name);
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const workbook = XLSX.read(event.target.result, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            setData(jsonData);
            if (jsonData.length > 0) {
              const firstDate = jsonData[0]['μ²λ¦¬μΌ'] || '';
              const match = firstDate.match(/(\d{4})\/(\d{2})/);
              if (match) setSelectedMonth(match[1] + '-' + match[2]);
            }
          } catch (err) { console.error(err); }
        };
        reader.readAsArrayBuffer(file);
      };

      const realData = useMemo(() => data.filter(item => !TEST_IDS.includes(item['κ³ κ°ID'])), [data]);
      const validData = useMemo(() => showCanceled ? realData : realData.filter(item => item['μ£Όλ¬Έμƒνƒ'] !== 'μ·¨μ†μ™„λ£'), [realData, showCanceled]);
      const canceledCount = useMemo(() => realData.filter(item => item['μ£Όλ¬Έμƒνƒ'] === 'μ·¨μ†μ™„λ£').length, [realData]);
      const monthlyData = useMemo(() => !selectedMonth ? validData : validData.filter(row => (row['μ²λ¦¬μΌ'] || '').startsWith(selectedMonth.replace('-', '/'))), [validData, selectedMonth]);
      
      // μ‚¬μ©μλ³„ κ²€μ¦μ©: μ·¨μ†μ™„λ£ ν¬ν•¨λ μ›”λ³„ λ°μ΄ν„°
      const monthlyAllData = useMemo(() => !selectedMonth ? realData : realData.filter(row => (row['μ²λ¦¬μΌ'] || '').startsWith(selectedMonth.replace('-', '/'))), [realData, selectedMonth]);
      
      const availableMonths = useMemo(() => { const m = new Set(); validData.forEach(r => { const d = r['μ²λ¦¬μΌ'] || ''; const match = d.match(/(\d{4})\/(\d{2})/); if(match) m.add(match[1]+'-'+match[2]); }); return Array.from(m).sort().reverse(); }, [validData]);
      const earnData = useMemo(() => monthlyData.filter(r => {
  if (r['νƒ€μ…'] === 'μ‚¬μ©') return false;
  const memo = r['κ΄€λ¦¬μλ©”λ¨'] || '';
  if (memo.includes('μ·¨μ† ν¬μΈνΈ') || memo.includes('μ·¨μ†ν¬μΈνΈ')) return false;
  return true;
}), [monthlyData]);
      const useData = useMemo(() => monthlyData.filter(r => r['νƒ€μ…'] === 'μ‚¬μ©'), [monthlyData]);

      const carryoverPoint = useMemo(() => {
        if (!selectedMonth) return 0;
        const prevData = validData.filter(row => { const d = row['μ²λ¦¬μΌ'] || ''; return d.substring(0,7).replace('/','-') < selectedMonth; });
        if (prevData.length === 0) return 0;
        const userLast = new Map();
        prevData.sort((a,b) => (a['μ²λ¦¬μΌ']||'').localeCompare(b['μ²λ¦¬μΌ']||'')).forEach(r => userLast.set(r['κ³ κ°ID'], Number(r['ν† νƒν¬μΈνΈ'])||0));
        return Array.from(userLast.values()).reduce((s,v) => s+v, 0);
      }, [validData, selectedMonth]);
      
const monthlyTotals = useMemo(() => {
  let used=0, earned=0;
  monthlyData.forEach(r => { const p = Number(r['ν¬μΈνΈ'])||0; if(r['νƒ€μ…']==='μ‚¬μ©') used+=p; });
  earnData.forEach(r => { earned += Number(r['ν¬μΈνΈ'])||0; });
        return { used, earned, carryover: carryoverPoint, balance: carryoverPoint + earned + used };
      }, [monthlyData, earnData, carryoverPoint]);

      const earnByType = useMemo(() => {
        const map = new Map();
        earnData.forEach(row => {
          let memo = (row['κ΄€λ¦¬μλ©”λ¨'] || '(λ©”λ¨μ—†μ)').trim().replace(/\n/g, '');
          const point = Number(row['ν¬μΈνΈ']) || 0;
          const userId = row['κ³ κ°ID'];
          const date = (row['μ²λ¦¬μΌ'] || '').substring(0, 10);
          if (!map.has(memo)) map.set(memo, { memo, totalPoint: 0, users: new Set(), dates: new Map() });
          const item = map.get(memo);
          item.totalPoint += point;
          item.users.add(userId);
          if (!item.dates.has(date)) item.dates.set(date, { point: 0, count: 0 });
          item.dates.get(date).point += point;
          item.dates.get(date).count += 1;
        });
        return Array.from(map.values()).map(item => ({
          memo: item.memo, totalPoint: item.totalPoint, userCount: item.users.size,
          dateList: Array.from(item.dates.entries()).map(([d, v]) => ({ date: d, point: v.point, count: v.count })).sort((a,b) => a.date.localeCompare(b.date))
        })).sort((a,b) => b.totalPoint - a.totalPoint);
      }, [earnData]);

      // μ—…μ²΄λ³„: CS μλ™μ°¨κ° μ μΌ λ’¤λ΅
      const companyStats = useMemo(() => {
        const map = new Map();
        useData.forEach(row => {
          const company = row['μ—…μ²΄λ…'] || 'CS μλ™μ°¨κ°';
          const point = Number(row['ν¬μΈνΈ']) || 0;
          const userId = row['κ³ κ°ID'];
          if (!map.has(company)) map.set(company, { company, usedPoint: 0, users: new Set() });
          map.get(company).usedPoint += point;
          map.get(company).users.add(userId);
        });
        return Array.from(map.values()).map(c => ({ company: c.company, usedPoint: c.usedPoint, userCount: c.users.size })).sort((a,b) => {
          if (a.company === 'CS μλ™μ°¨κ°') return 1;
          if (b.company === 'CS μλ™μ°¨κ°') return -1;
          return a.usedPoint - b.usedPoint;
        });
      }, [useData]);

      // μƒν’λ³„: CS μλ™μ°¨κ° ν•λ‚λ΅ ν•©μΉ¨
      const productStats = useMemo(() => {
        const map = new Map();
        useData.forEach(row => {
          const productCode = row['μƒν’μ½”λ“'] || '';
          const company = row['μ—…μ²΄λ…'] || '';
          const point = Number(row['ν¬μΈνΈ']) || 0;
          const userId = row['κ³ κ°ID'];
          
          // μƒν’μ½”λ“ μ—†μΌλ©΄ CS μλ™μ°¨κ°μΌλ΅ ν•©μΉ¨
          if (!productCode) {
            const key = '__CS_MANUAL__';
            if (!map.has(key)) map.set(key, { productCode: '-', company: 'CS μλ™μ°¨κ°', productName: '(μλ™ μ°¨κ° ν•©κ³„)', usedPoint: 0, users: new Set() });
            map.get(key).usedPoint += point;
            map.get(key).users.add(userId);
            return;
          }
          
          const memo = row['μ‚¬μ©μλ©”λ¨'] || row['κ΄€λ¦¬μλ©”λ¨'] || '';
          const match = memo.match(/μƒν’λ…\(([^)]+)\)/);
          const productName = match ? match[1] : (memo || '-');
          const key = productCode;
          if (!map.has(key)) map.set(key, { productCode, company: company || '-', productName, usedPoint: 0, users: new Set() });
          map.get(key).usedPoint += point;
          map.get(key).users.add(userId);
        });
        return Array.from(map.values()).map(p => ({ productCode: p.productCode, company: p.company, productName: p.productName, usedPoint: p.usedPoint, userCount: p.users.size })).sort((a,b) => {
          if (a.productCode === '-') return 1;
          if (b.productCode === '-') return -1;
          return a.usedPoint - b.usedPoint;
        });
      }, [useData]);

      // μ‚¬μ©μλ³„: μ·¨μ†μ™„λ£ ν¬ν•¨ν•΄μ„ κ³„μ‚°
      const userStats = useMemo(() => {
        const map = new Map();
        const sorted = [...monthlyAllData].sort((a,b) => (a['μ²λ¦¬μΌ']||'').localeCompare(b['μ²λ¦¬μΌ']||''));
        sorted.forEach(row => {
          const id = row['κ³ κ°ID'], name = row['κ³ κ°λ…'], point = Number(row['ν¬μΈνΈ'])||0, total = Number(row['ν† νƒν¬μΈνΈ'])||0, type = row['νƒ€μ…'], date = row['μ²λ¦¬μΌ']||'';
          if (!map.has(id)) map.set(id, { id, name, startPoint:0, earnedPoint:0, usedPoint:0, currentPoint:0, calculatedPoint:0, mismatch:false, transactions:[], lastDate:'', lastOrderNo:'' });
          const u = map.get(id);
          u.name = name;
          if (type === 'μ‚¬μ©') u.usedPoint += point; else u.earnedPoint += point;
          const orderNo = row['μ£Όλ¬Έλ²νΈ'] || '';
          if (date > u.lastDate) { u.currentPoint = total; u.lastDate = date; u.lastOrderNo = orderNo; }
          else if (date === u.lastDate && total < u.currentPoint) u.currentPoint = total;
          u.transactions.push({ date, type, point, total, memo: row['μ‚¬μ©μλ©”λ¨'] || row['κ΄€λ¦¬μλ©”λ¨'] || '', status: row['μ£Όλ¬Έμƒνƒ'] || '' });
        });
        if (selectedMonth) {
          // μ΄μ „ λ°μ΄ν„°λ„ μ·¨μ†μ™„λ£ ν¬ν•¨
          const prevData = realData.filter(r => (r['μ²λ¦¬μΌ']||'').substring(0,7).replace('/','-') < selectedMonth).sort((a,b) => (a['μ²λ¦¬μΌ']||'').localeCompare(b['μ²λ¦¬μΌ']||''));
          const prevUser = new Map();
          prevData.forEach(r => prevUser.set(r['κ³ κ°ID'], Number(r['ν† νƒν¬μΈνΈ'])||0));
          map.forEach((u, id) => {
            if (prevUser.has(id)) u.startPoint = prevUser.get(id);
            else if (u.transactions.length > 0) {
              const sortedTx = [...u.transactions].sort((a,b) => a.date.localeCompare(b.date));
              const firstDate = sortedTx[0].date;
              const sameDateTx = sortedTx.filter(t => t.date === firstDate);
              const minTotal = Math.min(...sameDateTx.map(t => t.total));
              const sumPoints = sameDateTx.reduce((s, t) => s + t.point, 0);
              u.startPoint = minTotal - sumPoints;
            }
            u.calculatedPoint = u.startPoint + u.earnedPoint + u.usedPoint;
            u.mismatch = Math.abs(u.calculatedPoint - u.currentPoint) > 1;
          });
        }
        return Array.from(map.values()).filter(u => u.usedPoint !== 0 || u.earnedPoint !== 0).sort((a,b) => a.usedPoint - b.usedPoint);
      }, [monthlyAllData, realData, selectedMonth]);

      const mismatchCount = useMemo(() => userStats.filter(u => u.mismatch).length, [userStats]);
      const filteredEarnByType = useMemo(() => !searchTerm ? earnByType : earnByType.filter(e => e.memo.toLowerCase().includes(searchTerm.toLowerCase())), [earnByType, searchTerm]);
      const filteredCompanyStats = useMemo(() => !searchTerm ? companyStats : companyStats.filter(c => c.company.toLowerCase().includes(searchTerm.toLowerCase())), [companyStats, searchTerm]);
      const filteredProductStats = useMemo(() => !searchTerm ? productStats : productStats.filter(p => p.productCode.toLowerCase().includes(searchTerm.toLowerCase()) || p.company.toLowerCase().includes(searchTerm.toLowerCase()) || p.productName.toLowerCase().includes(searchTerm.toLowerCase())), [productStats, searchTerm]);
      const filteredUserStats = useMemo(() => { let r = showMismatchOnly ? userStats.filter(u => u.mismatch) : userStats; if(!searchTerm) return r; const l = searchTerm.toLowerCase(); return r.filter(u => (u.name||'').toLowerCase().includes(l) || (u.id||'').toLowerCase().includes(l)); }, [userStats, searchTerm, showMismatchOnly]);

      const handleDownload = () => {
        let downloadData = [], sheetName = '';
        const monthLabel = selectedMonth || 'μ „μ²΄';
        if (mainTab === 'earn') { downloadData = filteredEarnByType.map(e => ({ 'μ λ¦½μ ν•': e.memo, 'μ λ¦½ν¬μΈνΈ': e.totalPoint, 'μΈμ›': e.userCount })); sheetName = 'μ λ¦½λ‚΄μ—­'; }
        else if (useSubTab === 'company') { downloadData = filteredCompanyStats.map(c => ({ 'μ—…μ²΄λ…': c.company, 'μ‚¬μ©ν¬μΈνΈ': c.usedPoint, 'μΈμ›': c.userCount })); sheetName = 'μ—…μ²΄λ³„'; }
        else if (useSubTab === 'product') { downloadData = filteredProductStats.map(p => ({ 'μƒν’μ½”λ“': p.productCode, 'μ…μ μ‚¬': p.company, 'μƒν’λ…': p.productName, 'μ‚¬μ©ν¬μΈνΈ': p.usedPoint, 'μΈμ›': p.userCount })); sheetName = 'μƒν’λ³„'; }
        else { downloadData = filteredUserStats.map(u => ({ 'κ³ κ°ID': u.id, 'κ³ κ°λ…': u.name, 'μ‹μ‘': u.startPoint, 'μ λ¦½': u.earnedPoint, 'μ‚¬μ©': u.usedPoint, 'κ³„μ‚°μ”μ—¬': u.calculatedPoint, 'μ‹¤μ μ”μ—¬': u.currentPoint, 'λ¶μΌμΉ': u.mismatch ? 'O' : '' })); sheetName = 'μ‚¬μ©μλ³„'; }
        const ws = XLSX.utils.json_to_sheet(downloadData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, monthLabel + '_' + sheetName + '.xlsx');
      };

      const getMonthLabel = () => { if(!selectedMonth) return ''; const p = selectedMonth.split('-'); return p[0] + 'λ…„ ' + parseInt(p[1]) + 'μ›”'; };

      const colors = { primary: '#1e3a5f', success: '#0d7c66', danger: '#c62828', muted: '#64748b', light: '#f1f5f9', border: '#e2e8f0' };
      const mainTabStyle = (tab) => ({ padding: '8px 20px', border: '1px solid ' + colors.border, backgroundColor: mainTab === tab ? (tab === 'earn' ? colors.success : colors.danger) : '#fff', color: mainTab === tab ? 'white' : colors.muted, cursor: 'pointer', fontWeight: '600', fontSize: '13px', borderRadius: tab === 'earn' ? '4px 0 0 4px' : '0 4px 4px 0' });
      const subTabStyle = (tab) => ({ padding: '8px 16px', border: 'none', borderBottom: useSubTab === tab ? '2px solid ' + colors.danger : '2px solid transparent', backgroundColor: 'transparent', cursor: 'pointer', fontWeight: useSubTab === tab ? '600' : '400', fontSize: '13px', color: useSubTab === tab ? colors.danger : colors.muted });
      const thStyle = { padding: '10px 12px', textAlign: 'left', borderBottom: '1px solid ' + colors.border, backgroundColor: colors.light, fontSize: '12px', fontWeight: '600', color: colors.muted };
      const tdStyle = { padding: '10px 12px', borderBottom: '1px solid ' + colors.border, fontSize: '13px' };
      const cardStyle = { backgroundColor: 'white', borderRadius: '4px', padding: '10px 14px', boxShadow: '0 1px 2px rgba(0,0,0,0.04)', flex: 1, minWidth: '100px', borderLeft: '3px solid' };
      const inputStyle = { padding: '8px 12px', border: '1px solid ' + colors.border, borderRadius: '4px', fontSize: '13px', outline: 'none' };
      const btnStyle = { padding: '8px 16px', borderRadius: '4px', border: 'none', cursor: 'pointer', fontSize: '12px', fontWeight: '500' };

      return (
        <div style={{ padding: '16px 20px', backgroundColor: '#f8f9fa', minHeight: '100vh', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }}>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
            <h1 style={{ fontSize: '18px', fontWeight: '600', color: colors.primary, margin: 0 }}>{getMonthLabel()} ν¬μΈνΈ ν„ν™©</h1>
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
              {availableMonths.length > 0 && (<select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} style={{ ...inputStyle, minWidth: '120px' }}><option value="">μ „μ²΄ κΈ°κ°„</option>{availableMonths.map(m => (<option key={m} value={m}>{m.replace('-', 'λ…„ ')}μ›”</option>))}</select>)}
              <label style={{ ...btnStyle, backgroundColor: colors.primary, color: 'white' }}>νμΌ μ„ νƒ<input type="file" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} style={{ display: 'none' }} /></label>
            </div>
          </div>

          {data.length > 0 && (<div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '12px', fontSize: '12px', color: colors.muted }}><span>{fileName}</span><label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}><input type="checkbox" checked={showCanceled} onChange={(e) => setShowCanceled(e.target.checked)} />μ·¨μ†μ™„λ£ ν¬ν•¨ ({canceledCount}κ±΄)</label></div>)}

          {data.length > 0 && (
            <Fragment>
              <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
                <div style={{ ...cardStyle, borderLeftColor: colors.muted }}><div style={{ fontSize: '11px', color: colors.muted }}>μ „μ›”μ΄μ›”</div><div style={{ fontSize: '15px', fontWeight: '600', color: '#374151' }}>{monthlyTotals.carryover.toLocaleString()}</div></div>
                <div style={{ ...cardStyle, borderLeftColor: colors.success }}><div style={{ fontSize: '11px', color: colors.muted }}>μ λ¦½ ({earnData.length})</div><div style={{ fontSize: '15px', fontWeight: '600', color: colors.success }}>+{monthlyTotals.earned.toLocaleString()}</div></div>
                <div style={{ ...cardStyle, borderLeftColor: colors.danger }}><div style={{ fontSize: '11px', color: colors.muted }}>μ‚¬μ© ({useData.length})</div><div style={{ fontSize: '15px', fontWeight: '600', color: colors.danger }}>{monthlyTotals.used.toLocaleString()}</div></div>
                <div style={{ ...cardStyle, borderLeftColor: colors.primary, backgroundColor: '#f0f4f8' }}><div style={{ fontSize: '11px', color: colors.muted }}>μ”μ—¬</div><div style={{ fontSize: '15px', fontWeight: '600', color: colors.primary }}>{monthlyTotals.balance.toLocaleString()}</div></div>
              </div>

              <div style={{ marginBottom: '12px' }}>
                <button style={mainTabStyle('earn')} onClick={() => { setMainTab('earn'); setSearchTerm(''); }}>+ μ λ¦½λ‚΄μ—­</button>
                <button style={mainTabStyle('use')} onClick={() => { setMainTab('use'); setSearchTerm(''); }}>- μ‚¬μ©λ‚΄μ—­</button>
              </div>

              {mainTab === 'earn' && (
                <div style={{ backgroundColor: 'white', borderRadius: '6px', boxShadow: '0 1px 3px rgba(0,0,0,0.06)', overflow: 'hidden' }}>
                  <div style={{ padding: '10px 12px', display: 'flex', gap: '8px', borderBottom: '1px solid ' + colors.border, alignItems: 'center' }}>
                    <input type="text" placeholder="μ λ¦½μ ν• κ²€μƒ‰..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, flex: 1 }} />
                    <button onClick={handleDownload} style={{ ...btnStyle, backgroundColor: colors.success, color: 'white' }}>λ‹¤μ΄λ΅λ“</button>
                  </div>
                  <div style={{ padding: '8px 12px', backgroundColor: colors.light, borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted }}>{filteredEarnByType.length}κ° μ ν• / {earnData.length}κ±΄ / {new Set(earnData.map(e => e['κ³ κ°ID'])).size}λ…</div>
                  <div style={{ maxHeight: 'calc(100vh - 300px)', overflowY: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                      <thead style={{ position: 'sticky', top: 0 }}><tr><th style={{ ...thStyle, width: '30px' }}></th><th style={thStyle}>μ λ¦½μ ν•</th><th style={{ ...thStyle, textAlign: 'right', width: '120px' }}>μ λ¦½ν¬μΈνΈ</th><th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>μΈμ›</th></tr></thead>
                      <tbody>
                        {filteredEarnByType.map((e, i) => (
                          <Fragment key={i}>
                            <tr style={{ cursor: 'pointer', backgroundColor: expandedEarn === i ? colors.light : 'transparent' }} onClick={() => setExpandedEarn(expandedEarn === i ? null : i)}>
                              <td style={tdStyle}>{expandedEarn === i ? 'β–Ό' : 'β–¶'}</td>
                              <td style={{ ...tdStyle, maxWidth: '400px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title={e.memo}>{e.memo}</td>
                              <td style={{ ...tdStyle, textAlign: 'right', color: colors.success, fontWeight: '600' }}>+{e.totalPoint.toLocaleString()}</td>
                              <td style={{ ...tdStyle, textAlign: 'right' }}>{e.userCount}</td>
                            </tr>
                            {expandedEarn === i && (<tr><td colSpan={4} style={{ padding: '0', backgroundColor: colors.light }}><div style={{ padding: '10px 16px' }}><table style={{ width: '100%', fontSize: '12px' }}><thead><tr><th style={{ padding: '6px 8px', textAlign: 'left', borderBottom: '1px solid ' + colors.border }}>μΌμ</th><th style={{ padding: '6px 8px', textAlign: 'right', borderBottom: '1px solid ' + colors.border }}>ν¬μΈνΈ</th><th style={{ padding: '6px 8px', textAlign: 'right', borderBottom: '1px solid ' + colors.border }}>κ±΄μ</th></tr></thead><tbody>{e.dateList.map((d, j) => (<tr key={j}><td style={{ padding: '6px 8px' }}>{d.date}</td><td style={{ padding: '6px 8px', textAlign: 'right', color: colors.success }}>+{d.point.toLocaleString()}</td><td style={{ padding: '6px 8px', textAlign: 'right' }}>{d.count}</td></tr>))}</tbody></table></div></td></tr>)}
                          </Fragment>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {mainTab === 'use' && (
                <div style={{ backgroundColor: 'white', borderRadius: '6px', boxShadow: '0 1px 3px rgba(0,0,0,0.06)', overflow: 'hidden' }}>
                  <div style={{ display: 'flex', borderBottom: '1px solid ' + colors.border }}>
                    <button style={subTabStyle('company')} onClick={() => { setUseSubTab('company'); setSearchTerm(''); }}>μ—…μ²΄λ³„</button>
                    <button style={subTabStyle('product')} onClick={() => { setUseSubTab('product'); setSearchTerm(''); }}>μƒν’λ³„</button>
                    <button style={subTabStyle('user')} onClick={() => { setUseSubTab('user'); setSearchTerm(''); }}>μ‚¬μ©μλ³„ {mismatchCount > 0 && <span style={{ color: colors.danger, marginLeft: '4px' }}>({mismatchCount})</span>}</button>
                  </div>
                  <div style={{ padding: '10px 12px', display: 'flex', gap: '8px', borderBottom: '1px solid ' + colors.border, alignItems: 'center' }}>
                    <input type="text" placeholder={useSubTab === 'company' ? 'μ—…μ²΄λ… κ²€μƒ‰...' : useSubTab === 'product' ? 'μƒν’μ½”λ“/μ…μ μ‚¬/μƒν’λ… κ²€μƒ‰...' : 'μ΄λ¦„/ID κ²€μƒ‰...'} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, flex: 1 }} />
                    {useSubTab === 'user' && mismatchCount > 0 && (<label style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', cursor: 'pointer', whiteSpace: 'nowrap' }}><input type="checkbox" checked={showMismatchOnly} onChange={(e) => setShowMismatchOnly(e.target.checked)} />λ¶μΌμΉλ§</label>)}
                    <button onClick={handleDownload} style={{ ...btnStyle, backgroundColor: colors.danger, color: 'white' }}>λ‹¤μ΄λ΅λ“</button>
                  </div>

                  {useSubTab === 'company' && (<Fragment><div style={{ padding: '8px 12px', backgroundColor: colors.light, borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted }}>{filteredCompanyStats.length}κ° μ—…μ²΄</div><div style={{ maxHeight: 'calc(100vh - 340px)', overflowY: 'auto' }}><table style={{ width: '100%', borderCollapse: 'collapse' }}><thead style={{ position: 'sticky', top: 0 }}><tr><th style={thStyle}>μ—…μ²΄λ…</th><th style={{ ...thStyle, textAlign: 'right', width: '120px' }}>μ‚¬μ©ν¬μΈνΈ</th><th style={{ ...thStyle, textAlign: 'right', width: '80px' }}>μΈμ›</th></tr></thead><tbody>{filteredCompanyStats.map((c, i) => (<tr key={i}><td style={{ ...tdStyle, color: c.company === 'CS μλ™μ°¨κ°' ? colors.muted : 'inherit', fontStyle: c.company === 'CS μλ™μ°¨κ°' ? 'italic' : 'normal' }}>{c.company}</td><td style={{ ...tdStyle, textAlign: 'right', color: colors.danger, fontWeight: '600' }}>{c.usedPoint.toLocaleString()}</td><td style={{ ...tdStyle, textAlign: 'right' }}>{c.userCount}</td></tr>))}</tbody></table></div></Fragment>)}

                  {useSubTab === 'product' && (<Fragment><div style={{ padding: '8px 12px', backgroundColor: colors.light, borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted }}>{filteredProductStats.length}κ° μƒν’</div><div style={{ maxHeight: 'calc(100vh - 340px)', overflowY: 'auto' }}><table style={{ width: '100%', borderCollapse: 'collapse' }}><thead style={{ position: 'sticky', top: 0 }}><tr><th style={{ ...thStyle, width: '100px' }}>μƒν’μ½”λ“</th><th style={{ ...thStyle, width: '120px' }}>μ…μ μ‚¬</th><th style={thStyle}>μƒν’λ…</th><th style={{ ...thStyle, textAlign: 'right', width: '110px' }}>μ‚¬μ©ν¬μΈνΈ</th><th style={{ ...thStyle, textAlign: 'right', width: '60px' }}>μΈμ›</th></tr></thead><tbody>{filteredProductStats.map((p, i) => (<tr key={i}><td style={{ ...tdStyle, fontFamily: 'monospace', fontSize: '11px', color: colors.muted }}>{p.productCode}</td><td style={{ ...tdStyle, fontSize: '12px', color: p.company === 'CS μλ™μ°¨κ°' ? colors.muted : 'inherit', fontStyle: p.company === 'CS μλ™μ°¨κ°' ? 'italic' : 'normal' }}>{p.company}</td><td style={{ ...tdStyle, maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title={p.productName}>{p.productName}</td><td style={{ ...tdStyle, textAlign: 'right', color: colors.danger, fontWeight: '600' }}>{p.usedPoint.toLocaleString()}</td><td style={{ ...tdStyle, textAlign: 'right' }}>{p.userCount}</td></tr>))}</tbody></table></div></Fragment>)}

                  {useSubTab === 'user' && (<Fragment><div style={{ padding: '8px 12px', backgroundColor: colors.light, borderBottom: '1px solid ' + colors.border, fontSize: '12px', color: colors.muted, display: 'flex', justifyContent: 'space-between' }}><span>{filteredUserStats.length}λ…</span>{mismatchCount > 0 && !showMismatchOnly && (<span style={{ color: colors.danger }}>λ¶μΌμΉ {mismatchCount}λ…</span>)}</div><div style={{ maxHeight: 'calc(100vh - 340px)', overflowY: 'auto' }}><table style={{ width: '100%', borderCollapse: 'collapse' }}><thead style={{ position: 'sticky', top: 0 }}><tr><th style={{ ...thStyle, width: '30px' }}></th><th style={thStyle}>μ΄λ¦„</th><th style={{ ...thStyle, textAlign: 'right', width: '90px' }}>μ‹μ‘</th><th style={{ ...thStyle, textAlign: 'right', width: '90px' }}>μ λ¦½</th><th style={{ ...thStyle, textAlign: 'right', width: '90px' }}>μ‚¬μ©</th><th style={{ ...thStyle, textAlign: 'right', width: '90px' }}>μ”μ—¬</th><th style={{ ...thStyle, textAlign: 'center', width: '60px' }}>κ²€μ¦</th></tr></thead><tbody>{filteredUserStats.map((u, i) => (<Fragment key={i}><tr style={{ cursor: 'pointer', backgroundColor: u.mismatch ? '#fef2f2' : (expandedUser === i ? colors.light : 'transparent') }} onClick={() => setExpandedUser(expandedUser === i ? null : i)}><td style={tdStyle}>{expandedUser === i ? 'β–Ό' : 'β–¶'}</td><td style={{ ...tdStyle, fontWeight: '500' }}>{u.name}</td><td style={{ ...tdStyle, textAlign: 'right', color: colors.muted }}>{u.startPoint.toLocaleString()}</td><td style={{ ...tdStyle, textAlign: 'right', color: colors.success }}>+{u.earnedPoint.toLocaleString()}</td><td style={{ ...tdStyle, textAlign: 'right', color: colors.danger, fontWeight: '600' }}>{u.usedPoint.toLocaleString()}</td><td style={{ ...tdStyle, textAlign: 'right', fontWeight: '600', color: colors.primary }}>{u.currentPoint.toLocaleString()}</td><td style={{ ...tdStyle, textAlign: 'center' }}>{u.mismatch ? <span style={{ color: colors.danger, fontSize: '11px' }}>β—</span> : <span style={{ color: colors.success, fontSize: '11px' }}>β“</span>}</td></tr>{expandedUser === i && (<tr><td colSpan={7} style={{ padding: '0', backgroundColor: colors.light }}><div style={{ padding: '10px 16px' }}><div style={{ fontSize: '11px', color: colors.muted, marginBottom: '8px', padding: '6px 10px', backgroundColor: 'white', borderRadius: '4px', display: 'inline-block' }}>{u.startPoint.toLocaleString()} + {u.earnedPoint.toLocaleString()} + ({u.usedPoint.toLocaleString()}) = {u.calculatedPoint.toLocaleString()}{u.mismatch && <span style={{ color: colors.danger, marginLeft: '8px' }}>β‰  μ‹¤μ  {u.currentPoint.toLocaleString()}</span>}</div><table style={{ width: '100%', fontSize: '12px' }}><thead><tr><th style={{ padding: '6px 8px', textAlign: 'left', borderBottom: '1px solid ' + colors.border }}>μΌμ‹</th><th style={{ padding: '6px 8px', textAlign: 'left', borderBottom: '1px solid ' + colors.border }}>νƒ€μ…</th><th style={{ padding: '6px 8px', textAlign: 'right', borderBottom: '1px solid ' + colors.border }}>ν¬μΈνΈ</th><th style={{ padding: '6px 8px', textAlign: 'right', borderBottom: '1px solid ' + colors.border }}>μ”μ•΅</th><th style={{ padding: '6px 8px', textAlign: 'left', borderBottom: '1px solid ' + colors.border }}>λ©”λ¨</th></tr></thead><tbody>{[...u.transactions].sort((a,b) => a.date.localeCompare(b.date)).map((tx, j) => (<tr key={j}><td style={{ padding: '6px 8px' }}>{tx.date}</td><td style={{ padding: '6px 8px' }}><span style={{ padding: '2px 6px', borderRadius: '3px', fontSize: '10px', backgroundColor: tx.type === 'μ‚¬μ©' ? '#fef2f2' : '#f0fdf4', color: tx.type === 'μ‚¬μ©' ? colors.danger : colors.success }}>{tx.type}</span></td><td style={{ padding: '6px 8px', textAlign: 'right', color: tx.point < 0 ? colors.danger : colors.success }}>{tx.point > 0 ? '+' : ''}{tx.point.toLocaleString()}</td><td style={{ padding: '6px 8px', textAlign: 'right' }}>{tx.total.toLocaleString()}</td><td style={{ padding: '6px 8px', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', color: colors.muted }} title={tx.memo}>{tx.memo || '-'}</td></tr>))}</tbody></table></div></td></tr>)}</Fragment>))}</tbody></table></div></Fragment>)}
                </div>
              )}
            </Fragment>
          )}

          {data.length === 0 && (<div style={{ backgroundColor: 'white', borderRadius: '6px', padding: '60px', textAlign: 'center', boxShadow: '0 1px 3px rgba(0,0,0,0.06)' }}><div style={{ fontSize: '36px', marginBottom: '12px', opacity: 0.3 }}>π“</div><p style={{ color: colors.muted, margin: 0 }}>μ—‘μ…€ νμΌμ„ μ—…λ΅λ“ν•μ„Έμ”</p></div>)}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>




